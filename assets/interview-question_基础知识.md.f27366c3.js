import{_ as s,C as a,o as n,c as l,H as p,w as e,k as o,a as r,Q as c}from"./chunks/framework.80346561.js";const t=JSON.parse('{"title":"基础知识","description":"","frontmatter":{"createTime":"2022/10/13","tag":"nginx"},"headers":[],"relativePath":"interview-question/基础知识.md","filePath":"s/前端面试题/nginx/基础知识.md","lastUpdated":1696495218000}'),i={name:"interview-question/基础知识.md"},E=o("h1",{id:"基础知识",tabindex:"-1"},[r("基础知识 "),o("a",{class:"header-anchor",href:"#基础知识","aria-label":'Permalink to "基础知识"'},"​")],-1),y=c('<h2 id="基础命令" tabindex="-1">基础命令 <a class="header-anchor" href="#基础命令" aria-label="Permalink to &quot;基础命令&quot;">​</a></h2><h3 id="列出-nginx-相关软件包" tabindex="-1">列出 nginx 相关软件包 <a class="header-anchor" href="#列出-nginx-相关软件包" aria-label="Permalink to &quot;列出 nginx 相关软件包&quot;">​</a></h3><div class="language-js vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">yum list </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> grep nginx</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">yum list </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> grep nginx</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><ul><li>yum list：列出所有软件清单</li><li>yum list installed：列出已安装软件清单 -- 检测系统中是否安装某个软件</li><li>grep：用于查找文件中符合条件的字符串</li></ul><h3 id="安装-nginx" tabindex="-1">安装 nginx <a class="header-anchor" href="#安装-nginx" aria-label="Permalink to &quot;安装 nginx&quot;">​</a></h3><div class="language-js vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">yum install nginx</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">yum install nginx</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h3 id="查看-nginx-版本信息" tabindex="-1">查看 nginx 版本信息 <a class="header-anchor" href="#查看-nginx-版本信息" aria-label="Permalink to &quot;查看 nginx 版本信息&quot;">​</a></h3><div class="language-js vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">nginx </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">v</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">nginx </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">v</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h3 id="列出-nginx-相关目录" tabindex="-1">列出 nginx 相关目录 <a class="header-anchor" href="#列出-nginx-相关目录" aria-label="Permalink to &quot;列出 nginx 相关目录&quot;">​</a></h3><div class="language-js vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">rpm </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">ql nginx</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">rpm </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">ql nginx</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h3 id="全格式显示所有-nginx-运行进程" tabindex="-1">全格式显示所有 nginx 运行进程 <a class="header-anchor" href="#全格式显示所有-nginx-运行进程" aria-label="Permalink to &quot;全格式显示所有 nginx 运行进程&quot;">​</a></h3><div class="language-js vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">ps </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">ef </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> grep nginx</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">ps </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">ef </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> grep nginx</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><ul><li>ps：列出系统中当前运行的进程</li><li>-ef：-e 显示所有，-f 全格式显示，也可使用 aux，两者显示风格不同</li></ul><h3 id="开机自启" tabindex="-1">开机自启 <a class="header-anchor" href="#开机自启" aria-label="Permalink to &quot;开机自启&quot;">​</a></h3><h4 id="设置开机自启" tabindex="-1">设置开机自启 <a class="header-anchor" href="#设置开机自启" aria-label="Permalink to &quot;设置开机自启&quot;">​</a></h4><div class="language-js vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">systemctl enable nginx</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">systemctl enable nginx</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h4 id="关闭开机自启" tabindex="-1">关闭开机自启 <a class="header-anchor" href="#关闭开机自启" aria-label="Permalink to &quot;关闭开机自启&quot;">​</a></h4><div class="language-js vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">systemctl disable nginx</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">systemctl disable nginx</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>可用 reboot 重启服务器，配合 ps -ef | grep nginx 进行测试</p><h3 id="启动-停止-重启-重载" tabindex="-1">启动 &amp; 停止 &amp; 重启 &amp; 重载 <a class="header-anchor" href="#启动-停止-重启-重载" aria-label="Permalink to &quot;启动 &amp; 停止 &amp; 重启 &amp; 重载&quot;">​</a></h3><h4 id="启动-nginx" tabindex="-1">启动 nginx <a class="header-anchor" href="#启动-nginx" aria-label="Permalink to &quot;启动 nginx&quot;">​</a></h4><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">systemctl start nginx ｜ nginx</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">systemctl start nginx ｜ nginx</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h4 id="停止-nginx" tabindex="-1">停止 nginx <a class="header-anchor" href="#停止-nginx" aria-label="Permalink to &quot;停止 nginx&quot;">​</a></h4><div class="language-js vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">systemctl stop nginx </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> nginx </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">s stop</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">systemctl stop nginx </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> nginx </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">s stop</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h4 id="重启-nginx" tabindex="-1">重启 nginx <a class="header-anchor" href="#重启-nginx" aria-label="Permalink to &quot;重启 nginx&quot;">​</a></h4><div class="language-js vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">systemctl restart nginx </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> nginx </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">s reopen</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">systemctl restart nginx </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> nginx </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">s reopen</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h3 id="重载-nginx-更改-nginx-配置后需执行" tabindex="-1">重载 nginx，更改 nginx 配置后需执行 <a class="header-anchor" href="#重载-nginx-更改-nginx-配置后需执行" aria-label="Permalink to &quot;重载 nginx，更改 nginx 配置后需执行&quot;">​</a></h3><div class="language-js vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">systemctl reload nginx </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> nginx </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">s reload</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">systemctl reload nginx </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> nginx </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">s reload</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h3 id="杀死单个进程" tabindex="-1">杀死单个进程 <a class="header-anchor" href="#杀死单个进程" aria-label="Permalink to &quot;杀死单个进程&quot;">​</a></h3><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">kill </span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">9</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">PID</span><span style="color:#E1E4E8;">（进程ID）</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">kill </span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">9</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">PID</span><span style="color:#24292E;">（进程ID）</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h3 id="查看-nginx-最终配置" tabindex="-1">查看 nginx 最终配置 <a class="header-anchor" href="#查看-nginx-最终配置" aria-label="Permalink to &quot;查看 nginx 最终配置&quot;">​</a></h3><div class="language-js vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">nginx </span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">T</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">nginx </span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">T</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h3 id="检查配置项是否有问题-每次更改完先检查后重载" tabindex="-1">检查配置项是否有问题，每次更改完先检查后重载 <a class="header-anchor" href="#检查配置项是否有问题-每次更改完先检查后重载" aria-label="Permalink to &quot;检查配置项是否有问题，每次更改完先检查后重载&quot;">​</a></h3><h4 id="当前目录下" tabindex="-1">当前目录下 <a class="header-anchor" href="#当前目录下" aria-label="Permalink to &quot;当前目录下&quot;">​</a></h4><div class="language-js vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">nginx </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">t</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">nginx </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">t</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h4 id="不在当前目录" tabindex="-1">不在当前目录 <a class="header-anchor" href="#不在当前目录" aria-label="Permalink to &quot;不在当前目录&quot;">​</a></h4><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">nginx </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">t </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">c </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">配置路径</span><span style="color:#F97583;">&gt;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">nginx </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">t </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">c </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">配置路径</span><span style="color:#D73A49;">&gt;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h2 id="配置文件" tabindex="-1">配置文件 <a class="header-anchor" href="#配置文件" aria-label="Permalink to &quot;配置文件&quot;">​</a></h2><p>nginx.conf 文件默认配置</p><h3 id="上文日志格式中所涉及变量含义如下" tabindex="-1">上文日志格式中所涉及变量含义如下 <a class="header-anchor" href="#上文日志格式中所涉及变量含义如下" aria-label="Permalink to &quot;上文日志格式中所涉及变量含义如下&quot;">​</a></h3><ul><li>变量 含义</li><li>$remote_addr 客户端地址</li><li>$remote_user 已经过验证的用户名</li><li>$time_local 通用日志格式的本地时间</li><li>$request 完整的原始的请求行</li><li>$status 下发给客户端的响应码</li><li>$body_bytes_sent 下发给客户端的字节数</li><li>$http_referer 当前请求上一次页面访问的地址</li><li>$http_user_agent 客户端agent信息</li><li>$http_x_forwarded_for 获得用户ip</li></ul><h2 id="静态资源配置" tabindex="-1">静态资源配置 <a class="header-anchor" href="#静态资源配置" aria-label="Permalink to &quot;静态资源配置&quot;">​</a></h2><div class="language-js vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">server {</span></span>\n<span class="line"><span style="color:#E1E4E8;">  listen </span><span style="color:#79B8FF;">80</span><span style="color:#E1E4E8;">;</span></span>\n<span class="line"><span style="color:#E1E4E8;">  server_name static.deeruby.com;</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#E1E4E8;">  location </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">static {</span></span>\n<span class="line"><span style="color:#E1E4E8;">    root </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">home;</span></span>\n<span class="line"><span style="color:#E1E4E8;">    # alias </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">home</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">static;</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#E1E4E8;">    autoindex on;             # 开启静态资源目录</span></span>\n<span class="line"><span style="color:#E1E4E8;">    autoindex_exact_size off; # 文件单位 </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;"> on：字节      off：</span><span style="color:#79B8FF;">KB</span><span style="color:#E1E4E8;">、</span><span style="color:#79B8FF;">MB</span><span style="color:#E1E4E8;">、</span><span style="color:#79B8FF;">GB</span></span>\n<span class="line"><span style="color:#E1E4E8;">    autoindex_localtime off;  # 时间格式 </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;"> on：服务器时间 off：GMT时间</span></span>\n<span class="line"><span style="color:#E1E4E8;">    autoindex_format html;    # 目录格式</span></span>\n<span class="line"><span style="color:#E1E4E8;">  }</span></span>\n<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">server {</span></span>\n<span class="line"><span style="color:#24292E;">  listen </span><span style="color:#005CC5;">80</span><span style="color:#24292E;">;</span></span>\n<span class="line"><span style="color:#24292E;">  server_name static.deeruby.com;</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#24292E;">  location </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">static {</span></span>\n<span class="line"><span style="color:#24292E;">    root </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">home;</span></span>\n<span class="line"><span style="color:#24292E;">    # alias </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">home</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">static;</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#24292E;">    autoindex on;             # 开启静态资源目录</span></span>\n<span class="line"><span style="color:#24292E;">    autoindex_exact_size off; # 文件单位 </span><span style="color:#D73A49;">--</span><span style="color:#24292E;"> on：字节      off：</span><span style="color:#005CC5;">KB</span><span style="color:#24292E;">、</span><span style="color:#005CC5;">MB</span><span style="color:#24292E;">、</span><span style="color:#005CC5;">GB</span></span>\n<span class="line"><span style="color:#24292E;">    autoindex_localtime off;  # 时间格式 </span><span style="color:#D73A49;">--</span><span style="color:#24292E;"> on：服务器时间 off：GMT时间</span></span>\n<span class="line"><span style="color:#24292E;">    autoindex_format html;    # 目录格式</span></span>\n<span class="line"><span style="color:#24292E;">  }</span></span>\n<span class="line"><span style="color:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>访问 static.deeruby.com/static/othe… 成功，即配置成功</p><h4 id="root-与-alias-区别" tabindex="-1">root 与 alias 区别 <a class="header-anchor" href="#root-与-alias-区别" aria-label="Permalink to &quot;root 与 alias 区别&quot;">​</a></h4><ul><li>图中静态资源所在目录为：/home/static；root 查找静态资源的路径为其填写路径拼接 location 路径，alias 则直接寻找其填写路径；</li><li>alias 只能用于 location 中；</li></ul><h4 id="autoindex" tabindex="-1">autoindex <a class="header-anchor" href="#autoindex" aria-label="Permalink to &quot;autoindex&quot;">​</a></h4><p>开启 autoindex 可访问文件根目录</p><h2 id="反向代理" tabindex="-1">反向代理 <a class="header-anchor" href="#反向代理" aria-label="Permalink to &quot;反向代理&quot;">​</a></h2><h4 id="我们在服务器上跑一个-node-项目-配置用-域名-来代替-ip-端口-访问" tabindex="-1">我们在服务器上跑一个 node 项目，配置用 域名 来代替 ip + 端口 访问 <a class="header-anchor" href="#我们在服务器上跑一个-node-项目-配置用-域名-来代替-ip-端口-访问" aria-label="Permalink to &quot;我们在服务器上跑一个 node 项目，配置用 域名 来代替 ip + 端口 访问&quot;">​</a></h4><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">server {</span></span>\n<span class="line"><span style="color:#E1E4E8;">  listen       </span><span style="color:#79B8FF;">80</span><span style="color:#E1E4E8;">;</span></span>\n<span class="line"><span style="color:#E1E4E8;">  server_name  nginx.deeruby.com;</span></span>\n<span class="line"><span style="color:#E1E4E8;">  location </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> {</span></span>\n<span class="line"><span style="color:#E1E4E8;">    proxy_pass </span><span style="color:#F97583;">&lt;</span><span style="color:#B392F0;">http</span><span style="color:#E1E4E8;">:</span><span style="color:#6A737D;">//127.0.0.1:3002&gt;;</span></span>\n<span class="line"><span style="color:#E1E4E8;">  }</span></span>\n<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">server {</span></span>\n<span class="line"><span style="color:#24292E;">  listen       </span><span style="color:#005CC5;">80</span><span style="color:#24292E;">;</span></span>\n<span class="line"><span style="color:#24292E;">  server_name  nginx.deeruby.com;</span></span>\n<span class="line"><span style="color:#24292E;">  location </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> {</span></span>\n<span class="line"><span style="color:#24292E;">    proxy_pass </span><span style="color:#D73A49;">&lt;</span><span style="color:#6F42C1;">http</span><span style="color:#24292E;">:</span><span style="color:#6A737D;">//127.0.0.1:3002&gt;;</span></span>\n<span class="line"><span style="color:#24292E;">  }</span></span>\n<span class="line"><span style="color:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>其含义为用户访问 nginx.deeruby.com‾\\underline{nginx.deeruby.com}nginx.deeruby.com 的时候，将其反向代理到 127.0.0.1:3002‾\\underline{127.0.0.1:3002}127.0.0.1:3002 上</p><h4 id="解决跨域" tabindex="-1">解决跨域 <a class="header-anchor" href="#解决跨域" aria-label="Permalink to &quot;解决跨域&quot;">​</a></h4><p>tips：实际工作中，解决跨域一般为后端配置 CORS，详见笔者 20分钟，巩固你的HTTP知识体系 这篇文章中 HTTP请求方法 里 Options 部分</p><h5 id="hosts-配置" tabindex="-1">hosts 配置 <a class="header-anchor" href="#hosts-配置" aria-label="Permalink to &quot;hosts 配置&quot;">​</a></h5><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#79B8FF;">127.0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">0.1</span><span style="color:#E1E4E8;">       nginx.deeruby.com</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#005CC5;">127.0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">0.1</span><span style="color:#24292E;">       nginx.deeruby.com</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h6 id="nginx-配置" tabindex="-1">nginx 配置 <a class="header-anchor" href="#nginx-配置" aria-label="Permalink to &quot;nginx 配置&quot;">​</a></h6><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">server {</span></span>\n<span class="line"><span style="color:#E1E4E8;">  listen       </span><span style="color:#79B8FF;">80</span><span style="color:#E1E4E8;">;</span></span>\n<span class="line"><span style="color:#E1E4E8;">  server_name  nginx.deeruby.com;</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#E1E4E8;">  location </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> {</span></span>\n<span class="line"><span style="color:#E1E4E8;">    proxy_pass </span><span style="color:#F97583;">&lt;</span><span style="color:#B392F0;">http</span><span style="color:#E1E4E8;">:</span><span style="color:#6A737D;">//127.0.0.1:8080&gt;;</span></span>\n<span class="line"><span style="color:#E1E4E8;">  }</span></span>\n<span class="line"><span style="color:#E1E4E8;">  </span></span>\n<span class="line"><span style="color:#E1E4E8;">   location </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">api {</span></span>\n<span class="line"><span style="color:#E1E4E8;">      proxy_pass </span><span style="color:#F97583;">&lt;</span><span style="color:#B392F0;">http</span><span style="color:#E1E4E8;">:</span><span style="color:#6A737D;">//127.0.0.1:3002&gt;;</span></span>\n<span class="line"><span style="color:#E1E4E8;">      proxy_set_header Host $host;</span></span>\n<span class="line"><span style="color:#E1E4E8;">  }</span></span>\n<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">server {</span></span>\n<span class="line"><span style="color:#24292E;">  listen       </span><span style="color:#005CC5;">80</span><span style="color:#24292E;">;</span></span>\n<span class="line"><span style="color:#24292E;">  server_name  nginx.deeruby.com;</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#24292E;">  location </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> {</span></span>\n<span class="line"><span style="color:#24292E;">    proxy_pass </span><span style="color:#D73A49;">&lt;</span><span style="color:#6F42C1;">http</span><span style="color:#24292E;">:</span><span style="color:#6A737D;">//127.0.0.1:8080&gt;;</span></span>\n<span class="line"><span style="color:#24292E;">  }</span></span>\n<span class="line"><span style="color:#24292E;">  </span></span>\n<span class="line"><span style="color:#24292E;">   location </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">api {</span></span>\n<span class="line"><span style="color:#24292E;">      proxy_pass </span><span style="color:#D73A49;">&lt;</span><span style="color:#6F42C1;">http</span><span style="color:#24292E;">:</span><span style="color:#6A737D;">//127.0.0.1:3002&gt;;</span></span>\n<span class="line"><span style="color:#24292E;">      proxy_set_header Host $host;</span></span>\n<span class="line"><span style="color:#24292E;">  }</span></span>\n<span class="line"><span style="color:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><ul><li>其含义为用户访问 nginx.deeruby.com‾\\underline{nginx.deeruby.com}nginx.deeruby.com 的时候，将其反向代理到 127.0.0.1:8080‾\\underline{127.0.0.1:8080}127.0.0.1:8080 上（前端部分）；</li><li>访问 nginx.deeruby.com/api‾\\underline{nginx.deeruby.com/api}nginx.deeruby.com/api 的时候，将其反向代理到 127.0.0.1:3002/api‾\\underline{127.0.0.1:3002/api}127.0.0.1:3002/api 上（后端部分）；此时前后端同域，以此解决跨域问题。</li><li>proxy_set_header Host $host;：用来在后端获取用户发送过来的请求头，我们看图说话，第一行输出为没配置该指令，第二行为配置了该指令</li></ul><h2 id="https" tabindex="-1">HTTPS <a class="header-anchor" href="#https" aria-label="Permalink to &quot;HTTPS&quot;">​</a></h2><h3 id="配置https" tabindex="-1">配置HTTPS <a class="header-anchor" href="#配置https" aria-label="Permalink to &quot;配置HTTPS&quot;">​</a></h3><div class="language-js vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">server {</span></span>\n<span class="line"><span style="color:#E1E4E8;">  listen </span><span style="color:#79B8FF;">443</span><span style="color:#E1E4E8;"> ssl;                                      # 采用443端口，开启ssl</span></span>\n<span class="line"><span style="color:#E1E4E8;">  listen [::]:</span><span style="color:#79B8FF;">443</span><span style="color:#E1E4E8;"> ssl;</span></span>\n<span class="line"><span style="color:#E1E4E8;">  server_name sso.deeruby.com;</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#E1E4E8;">  # 证书配置</span></span>\n<span class="line"><span style="color:#E1E4E8;">  ssl_certificate </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">etc</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">nginx</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">ssl</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">sso</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">full_chain.pem;   # pem 文件路径</span></span>\n<span class="line"><span style="color:#E1E4E8;">  ssl_certificate_key </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">etc</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">nginx</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">ssl</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">sso</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">private.key;  # key 文件路径</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#E1E4E8;">  ssl_session_cache </span><span style="color:#B392F0;">shared</span><span style="color:#E1E4E8;">:</span><span style="color:#B392F0;">SSL</span><span style="color:#E1E4E8;">:1m;                     # 共享缓存大小</span></span>\n<span class="line"><span style="color:#E1E4E8;">  ssl_session_timeout 5m;                              # 超时时间</span></span>\n<span class="line"><span style="color:#E1E4E8;">  ssl_ciphers </span><span style="color:#B392F0;">HIGH</span><span style="color:#E1E4E8;">:</span><span style="color:#F97583;">!</span><span style="color:#B392F0;">aNULL</span><span style="color:#E1E4E8;">:</span><span style="color:#F97583;">!</span><span style="color:#79B8FF;">MD5</span><span style="color:#E1E4E8;">;                        # 加密算法</span></span>\n<span class="line"><span style="color:#E1E4E8;">  ssl_prefer_server_ciphers on;                        # 优先采取服务器算法</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#E1E4E8;">  location </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> {</span></span>\n<span class="line"><span style="color:#E1E4E8;">    proxy_pass </span><span style="color:#B392F0;">http</span><span style="color:#E1E4E8;">:</span><span style="color:#6A737D;">//127.0.0.1:3002;</span></span>\n<span class="line"><span style="color:#E1E4E8;">  }</span></span>\n<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">server {</span></span>\n<span class="line"><span style="color:#24292E;">  listen </span><span style="color:#005CC5;">443</span><span style="color:#24292E;"> ssl;                                      # 采用443端口，开启ssl</span></span>\n<span class="line"><span style="color:#24292E;">  listen [::]:</span><span style="color:#005CC5;">443</span><span style="color:#24292E;"> ssl;</span></span>\n<span class="line"><span style="color:#24292E;">  server_name sso.deeruby.com;</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#24292E;">  # 证书配置</span></span>\n<span class="line"><span style="color:#24292E;">  ssl_certificate </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">etc</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">nginx</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">ssl</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">sso</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">full_chain.pem;   # pem 文件路径</span></span>\n<span class="line"><span style="color:#24292E;">  ssl_certificate_key </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">etc</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">nginx</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">ssl</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">sso</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">private.key;  # key 文件路径</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#24292E;">  ssl_session_cache </span><span style="color:#6F42C1;">shared</span><span style="color:#24292E;">:</span><span style="color:#6F42C1;">SSL</span><span style="color:#24292E;">:1m;                     # 共享缓存大小</span></span>\n<span class="line"><span style="color:#24292E;">  ssl_session_timeout 5m;                              # 超时时间</span></span>\n<span class="line"><span style="color:#24292E;">  ssl_ciphers </span><span style="color:#6F42C1;">HIGH</span><span style="color:#24292E;">:</span><span style="color:#D73A49;">!</span><span style="color:#6F42C1;">aNULL</span><span style="color:#24292E;">:</span><span style="color:#D73A49;">!</span><span style="color:#005CC5;">MD5</span><span style="color:#24292E;">;                        # 加密算法</span></span>\n<span class="line"><span style="color:#24292E;">  ssl_prefer_server_ciphers on;                        # 优先采取服务器算法</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#24292E;">  location </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> {</span></span>\n<span class="line"><span style="color:#24292E;">    proxy_pass </span><span style="color:#6F42C1;">http</span><span style="color:#24292E;">:</span><span style="color:#6A737D;">//127.0.0.1:3002;</span></span>\n<span class="line"><span style="color:#24292E;">  }</span></span>\n<span class="line"><span style="color:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h4 id="访问-http-自动跳转至-https" tabindex="-1">访问 HTTP 自动跳转至 HTTPS <a class="header-anchor" href="#访问-http-自动跳转至-https" aria-label="Permalink to &quot;访问 HTTP 自动跳转至 HTTPS&quot;">​</a></h4><div class="language-js vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">server {</span></span>\n<span class="line"><span style="color:#E1E4E8;">  listen       </span><span style="color:#79B8FF;">80</span><span style="color:#E1E4E8;">;</span></span>\n<span class="line"><span style="color:#E1E4E8;">  server_name  sso.deeruby.com;</span></span>\n<span class="line"><span style="color:#E1E4E8;">  rewrite </span><span style="color:#F97583;">^</span><span style="color:#E1E4E8;">(.</span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">) </span><span style="color:#B392F0;">https</span><span style="color:#E1E4E8;">:</span><span style="color:#6A737D;">//$server_name$1 permanent;</span></span>\n<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">server {</span></span>\n<span class="line"><span style="color:#24292E;">  listen       </span><span style="color:#005CC5;">80</span><span style="color:#24292E;">;</span></span>\n<span class="line"><span style="color:#24292E;">  server_name  sso.deeruby.com;</span></span>\n<span class="line"><span style="color:#24292E;">  rewrite </span><span style="color:#D73A49;">^</span><span style="color:#24292E;">(.</span><span style="color:#D73A49;">*</span><span style="color:#24292E;">) </span><span style="color:#6F42C1;">https</span><span style="color:#24292E;">:</span><span style="color:#6A737D;">//$server_name$1 permanent;</span></span>\n<span class="line"><span style="color:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="rewrite" tabindex="-1">rewrite <a class="header-anchor" href="#rewrite" aria-label="Permalink to &quot;rewrite&quot;">​</a></h4><div class="language-js vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">rewrite   </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">regex</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">    &lt;</span><span style="color:#85E89D;">replacement</span><span style="color:#E1E4E8;">&gt;       [flag]</span></span>\n<span class="line"><span style="color:#E1E4E8;">            正则       跳转后的内容   rewrite支持的flag标记</span></span>\n<span class="line"><span style="color:#E1E4E8;">[flag]：permanent -- 301 永久重定向；redirect -- 302 临时重定向；</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">rewrite   </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">regex</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">    &lt;</span><span style="color:#22863A;">replacement</span><span style="color:#24292E;">&gt;       [flag]</span></span>\n<span class="line"><span style="color:#24292E;">            正则       跳转后的内容   rewrite支持的flag标记</span></span>\n<span class="line"><span style="color:#24292E;">[flag]：permanent -- 301 永久重定向；redirect -- 302 临时重定向；</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>故上文配置表示将当前路径永久重定向到 <a href="https://sso.deeruby.com/%E8%B7%AF%E5%BE%84%E2%80%BE%5Cunderline" target="_blank" rel="noreferrer">https://sso.deeruby.com/路径‾\\underline</a>{ <a href="https://sso.deeruby.com/" target="_blank" rel="noreferrer">https://sso.deeruby.com/</a>路径 }<a href="https://sso.deeruby.com/" target="_blank" rel="noreferrer">https://sso.deeruby.com/</a>路径 上</p><h2 id="图片防盗链" tabindex="-1">图片防盗链 <a class="header-anchor" href="#图片防盗链" aria-label="Permalink to &quot;图片防盗链&quot;">​</a></h2><ul><li>引言：referer请求头用于识别访问来源，以此来配置防盗链。</li><li>valid_referers：设置可访问资源的规则，其不允许的规则 $invalid_referer 值为1，对不允许的规则返回403。 字段 含义</li><li>none 允许没有 referer 字段的请求访问资源</li><li>blocked 允许非 HTTP(S) 开头的请求访问资源</li><li>server_names 允许指定域名 / IP 访问资源</li><li>[string] 正则匹配定义可访问资源的网址</li></ul><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">location </span><span style="color:#F97583;">~</span><span style="color:#9ECBFF;">/</span><span style="color:#DBEDFF;">static</span><span style="color:#9ECBFF;">/</span><span style="color:#E1E4E8;">.</span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">\\.(jpg</span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">jpeg</span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">png</span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">gif</span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">webp)$ {</span></span>\n<span class="line"><span style="color:#E1E4E8;">  root </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">home;</span></span>\n<span class="line"><span style="color:#E1E4E8;">valid_referers</span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">.deeruby.com;</span></span>\n<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> ($invalid_referer) {</span></span>\n<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">403</span><span style="color:#E1E4E8;">;</span></span>\n<span class="line"><span style="color:#E1E4E8;">  }</span></span>\n<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">location </span><span style="color:#D73A49;">~</span><span style="color:#032F62;">/static/</span><span style="color:#24292E;">.</span><span style="color:#D73A49;">*</span><span style="color:#24292E;">\\.(jpg</span><span style="color:#D73A49;">|</span><span style="color:#24292E;">jpeg</span><span style="color:#D73A49;">|</span><span style="color:#24292E;">png</span><span style="color:#D73A49;">|</span><span style="color:#24292E;">gif</span><span style="color:#D73A49;">|</span><span style="color:#24292E;">webp)$ {</span></span>\n<span class="line"><span style="color:#24292E;">  root </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">home;</span></span>\n<span class="line"><span style="color:#24292E;">valid_referers</span><span style="color:#D73A49;">*</span><span style="color:#24292E;">.deeruby.com;</span></span>\n<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> ($invalid_referer) {</span></span>\n<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">403</span><span style="color:#24292E;">;</span></span>\n<span class="line"><span style="color:#24292E;">  }</span></span>\n<span class="line"><span style="color:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>上述配置表示只有 ∗.deeruby.com*.deeruby.com∗.deeruby.com 可访问该资源，否则403报错</p><h2 id="访问限制" tabindex="-1">访问限制 <a class="header-anchor" href="#访问限制" aria-label="Permalink to &quot;访问限制&quot;">​</a></h2><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">location </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">static {</span></span>\n<span class="line"><span style="color:#E1E4E8;">  root </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">home;</span></span>\n<span class="line"><span style="color:#E1E4E8;">  allow 39.xxx.xxx.xxx;  # allow 允许</span></span>\n<span class="line"><span style="color:#E1E4E8;">  deny all;              # deny  拒绝</span></span>\n<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">location </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">static {</span></span>\n<span class="line"><span style="color:#24292E;">  root </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">home;</span></span>\n<span class="line"><span style="color:#24292E;">  allow 39.xxx.xxx.xxx;  # allow 允许</span></span>\n<span class="line"><span style="color:#24292E;">  deny all;              # deny  拒绝</span></span>\n<span class="line"><span style="color:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>表示允许 39.xxx.xxx.xxx 访问该目录，禁止其它所有 IP 访问，其生效顺序为谁先触发谁起作用。</p><h2 id="禁用请求方法" tabindex="-1">禁用请求方法 <a class="header-anchor" href="#禁用请求方法" aria-label="Permalink to &quot;禁用请求方法&quot;">​</a></h2><p>仅允许使用 GET、POST、HEAD、OPTIONS 这四种请求，使用其余请求返回403</p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> ($request_method </span><span style="color:#F97583;">!~</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">^</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">GET</span><span style="color:#F97583;">|</span><span style="color:#79B8FF;">POST</span><span style="color:#F97583;">|</span><span style="color:#79B8FF;">HEAD</span><span style="color:#F97583;">|</span><span style="color:#79B8FF;">OPTIONS</span><span style="color:#E1E4E8;">)$) {</span></span>\n<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">403</span><span style="color:#E1E4E8;">;</span></span>\n<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> ($request_method </span><span style="color:#D73A49;">!~</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">^</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">GET</span><span style="color:#D73A49;">|</span><span style="color:#005CC5;">POST</span><span style="color:#D73A49;">|</span><span style="color:#005CC5;">HEAD</span><span style="color:#D73A49;">|</span><span style="color:#005CC5;">OPTIONS</span><span style="color:#24292E;">)$) {</span></span>\n<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">403</span><span style="color:#24292E;">;</span></span>\n<span class="line"><span style="color:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="缓存" tabindex="-1">缓存 <a class="header-anchor" href="#缓存" aria-label="Permalink to &quot;缓存&quot;">​</a></h2><div class="language-js vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">expires 7d;  # 缓存7天</span></span>\n<span class="line"><span style="color:#E1E4E8;">expires </span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">;  # 不缓存</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">expires 7d;  # 缓存7天</span></span>\n<span class="line"><span style="color:#24292E;">expires </span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">;  # 不缓存</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="pc端和移动端使用不同项目" tabindex="-1">PC端和移动端使用不同项目 <a class="header-anchor" href="#pc端和移动端使用不同项目" aria-label="Permalink to &quot;PC端和移动端使用不同项目&quot;">​</a></h2><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">location </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> {</span></span>\n<span class="line"><span style="color:#E1E4E8;">  root </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">home</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">static</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">pc;</span></span>\n<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> ($http_user_agent </span><span style="color:#F97583;">~*</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;(mobile|android|iphone|ipod|phone)&#39;</span><span style="color:#E1E4E8;">) {</span></span>\n<span class="line"><span style="color:#E1E4E8;">    root </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">home</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">static</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">mobile;</span></span>\n<span class="line"><span style="color:#E1E4E8;">  }</span></span>\n<span class="line"><span style="color:#E1E4E8;">  index index.html;</span></span>\n<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">location </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> {</span></span>\n<span class="line"><span style="color:#24292E;">  root </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">home</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">static</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">pc;</span></span>\n<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> ($http_user_agent </span><span style="color:#D73A49;">~*</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;(mobile|android|iphone|ipod|phone)&#39;</span><span style="color:#24292E;">) {</span></span>\n<span class="line"><span style="color:#24292E;">    root </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">home</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">static</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">mobile;</span></span>\n<span class="line"><span style="color:#24292E;">  }</span></span>\n<span class="line"><span style="color:#24292E;">  index index.html;</span></span>\n<span class="line"><span style="color:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>注意：条件语句中不能使用别名，若有需求，可采取折中方案，重定向移动端网址</p><h2 id="负载均衡" tabindex="-1">负载均衡 <a class="header-anchor" href="#负载均衡" aria-label="Permalink to &quot;负载均衡&quot;">​</a></h2><div class="language-js vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">upstream backserver {              # 存放负载均衡所需变量</span></span>\n<span class="line"><span style="color:#E1E4E8;">  ip_hash;                         # 根据用户访问 </span><span style="color:#79B8FF;">IP</span><span style="color:#E1E4E8;"> 的 hash 分配，这样每个访客固定访问一个后端服务，可有效解决动态网页存在的 session 共享问题</span></span>\n<span class="line"><span style="color:#E1E4E8;">  # fair;                          # 根据页面大小和加载时间长短智能地进行负载均衡，响应时间短的优先分配</span></span>\n<span class="line"><span style="color:#E1E4E8;">  server </span><span style="color:#79B8FF;">127.0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">0.1</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">9090</span><span style="color:#E1E4E8;">; </span></span>\n<span class="line"><span style="color:#E1E4E8;">  server </span><span style="color:#79B8FF;">127.0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">0.1</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">8080</span><span style="color:#E1E4E8;"> weight</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">;  # 加权，权重越大，被访问概率越大</span></span>\n<span class="line"><span style="color:#E1E4E8;">  server </span><span style="color:#79B8FF;">127.0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">0.1</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">7070</span><span style="color:#E1E4E8;"> down;      # 该 server 不参与负载均衡</span></span>\n<span class="line"><span style="color:#E1E4E8;">  server </span><span style="color:#79B8FF;">127.0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">0.1</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">6060</span><span style="color:#E1E4E8;"> backup;    # 其余 server 均不可用时，使用这个</span></span>\n<span class="line"><span style="color:#E1E4E8;">}</span></span>\n<span class="line"><span style="color:#E1E4E8;">server {</span></span>\n<span class="line"><span style="color:#E1E4E8;">  location </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> {</span></span>\n<span class="line"><span style="color:#E1E4E8;">    proxy_pass </span><span style="color:#B392F0;">http</span><span style="color:#E1E4E8;">:</span><span style="color:#6A737D;">//backserver;  # 接入负载均衡相关配置</span></span>\n<span class="line"><span style="color:#E1E4E8;">    proxy_redirect </span><span style="color:#F97583;">default</span><span style="color:#E1E4E8;">;</span></span>\n<span class="line"><span style="color:#E1E4E8;">  }</span></span>\n<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">upstream backserver {              # 存放负载均衡所需变量</span></span>\n<span class="line"><span style="color:#24292E;">  ip_hash;                         # 根据用户访问 </span><span style="color:#005CC5;">IP</span><span style="color:#24292E;"> 的 hash 分配，这样每个访客固定访问一个后端服务，可有效解决动态网页存在的 session 共享问题</span></span>\n<span class="line"><span style="color:#24292E;">  # fair;                          # 根据页面大小和加载时间长短智能地进行负载均衡，响应时间短的优先分配</span></span>\n<span class="line"><span style="color:#24292E;">  server </span><span style="color:#005CC5;">127.0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">0.1</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">9090</span><span style="color:#24292E;">; </span></span>\n<span class="line"><span style="color:#24292E;">  server </span><span style="color:#005CC5;">127.0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">0.1</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">8080</span><span style="color:#24292E;"> weight</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">;  # 加权，权重越大，被访问概率越大</span></span>\n<span class="line"><span style="color:#24292E;">  server </span><span style="color:#005CC5;">127.0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">0.1</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">7070</span><span style="color:#24292E;"> down;      # 该 server 不参与负载均衡</span></span>\n<span class="line"><span style="color:#24292E;">  server </span><span style="color:#005CC5;">127.0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">0.1</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">6060</span><span style="color:#24292E;"> backup;    # 其余 server 均不可用时，使用这个</span></span>\n<span class="line"><span style="color:#24292E;">}</span></span>\n<span class="line"><span style="color:#24292E;">server {</span></span>\n<span class="line"><span style="color:#24292E;">  location </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> {</span></span>\n<span class="line"><span style="color:#24292E;">    proxy_pass </span><span style="color:#6F42C1;">http</span><span style="color:#24292E;">:</span><span style="color:#6A737D;">//backserver;  # 接入负载均衡相关配置</span></span>\n<span class="line"><span style="color:#24292E;">    proxy_redirect </span><span style="color:#D73A49;">default</span><span style="color:#24292E;">;</span></span>\n<span class="line"><span style="color:#24292E;">  }</span></span>\n<span class="line"><span style="color:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h2 id="限速限流" tabindex="-1">限速限流 <a class="header-anchor" href="#限速限流" aria-label="Permalink to &quot;限速限流&quot;">​</a></h2><p>limit_conn 连接频率限制：TCP连接</p><div class="language-js vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">limit_conn_zone $binary_remote_addr zone</span><span style="color:#F97583;">=</span><span style="color:#B392F0;">conname</span><span style="color:#E1E4E8;">:10m;</span></span>\n<span class="line"><span style="color:#E1E4E8;">server {</span></span>\n<span class="line"><span style="color:#E1E4E8;">   limit_conn conname </span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">;  # 每个 </span><span style="color:#79B8FF;">IP</span><span style="color:#E1E4E8;"> 只能发起3个连接</span></span>\n<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">limit_conn_zone $binary_remote_addr zone</span><span style="color:#D73A49;">=</span><span style="color:#6F42C1;">conname</span><span style="color:#24292E;">:10m;</span></span>\n<span class="line"><span style="color:#24292E;">server {</span></span>\n<span class="line"><span style="color:#24292E;">   limit_conn conname </span><span style="color:#005CC5;">3</span><span style="color:#24292E;">;  # 每个 </span><span style="color:#005CC5;">IP</span><span style="color:#24292E;"> 只能发起3个连接</span></span>\n<span class="line"><span style="color:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>limit_req 请求频率限制：API请求</p><div class="language-js vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">limit_req_zone $binary_remtoe_addr zone</span><span style="color:#F97583;">=</span><span style="color:#B392F0;">conname</span><span style="color:#E1E4E8;">:1m rate</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">10r</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">s;</span></span>\n<span class="line"><span style="color:#E1E4E8;">server {</span></span>\n<span class="line"><span style="color:#E1E4E8;">   limit_req zone</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">conname burst</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">5</span><span style="color:#E1E4E8;"> nodelay;  # 最大请求数为5，且超过的请求不延迟</span></span>\n<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">limit_req_zone $binary_remtoe_addr zone</span><span style="color:#D73A49;">=</span><span style="color:#6F42C1;">conname</span><span style="color:#24292E;">:1m rate</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">10r</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">s;</span></span>\n<span class="line"><span style="color:#24292E;">server {</span></span>\n<span class="line"><span style="color:#24292E;">   limit_req zone</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">conname burst</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">5</span><span style="color:#24292E;"> nodelay;  # 最大请求数为5，且超过的请求不延迟</span></span>\n<span class="line"><span style="color:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>内容 含义</p><ul><li>$binary_remote_addr 这里填写的是限流对象，我们采用客户端IP</li><li>zone=conname 给共享空间设置名称为：conname</li><li>10m 空间大小：10兆</li><li>rate 速率，上述表示每秒最多发起10个请求</li><li>limit_conn 限制每个name对应的连接数</li><li>limit_req 限制每个name对应的请求数</li></ul><div class="language-js vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">server {</span></span>\n<span class="line"><span style="color:#E1E4E8;">   limit_rate_after 10m;  # 前10兆大小不限速</span></span>\n<span class="line"><span style="color:#E1E4E8;">   limit_rate 100k;       # 限速为 100</span><span style="color:#79B8FF;">KB</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">秒</span></span>\n<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">server {</span></span>\n<span class="line"><span style="color:#24292E;">   limit_rate_after 10m;  # 前10兆大小不限速</span></span>\n<span class="line"><span style="color:#24292E;">   limit_rate 100k;       # 限速为 100</span><span style="color:#005CC5;">KB</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">秒</span></span>\n<span class="line"><span style="color:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>这里可用 ab 命令进行压测 ab -n[number] -c[number] -k url 字段 含义</p><ul><li>-n 一共发送多少请求</li><li>-c 同时发送多少请求</li><li>-k keep-alive</li></ul><h2 id="其它" tabindex="-1">其它 <a class="header-anchor" href="#其它" aria-label="Permalink to &quot;其它&quot;">​</a></h2><h3 id="开启gzip" tabindex="-1">开启gzip <a class="header-anchor" href="#开启gzip" aria-label="Permalink to &quot;开启gzip&quot;">​</a></h3><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">gzip on;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">gzip on;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div>',97);const d=s(i,[["render",function(s,o,r,c,t,i){const d=a("ArticleMetadata"),b=a("ClientOnly");return n(),l("div",null,[E,p(b,null,{default:e((()=>[p(d)])),_:1}),y])}]]);export{t as __pageData,d as default};
