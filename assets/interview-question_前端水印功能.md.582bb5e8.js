import{_ as s,C as n,o as a,c as l,H as p,w as o,k as e,a as r,Q as t}from"./chunks/framework.f92cd432.js";const c=JSON.parse('{"title":"前端水印功能","description":"","frontmatter":{"createTime":"2022/11/17","tags":"场景题"},"headers":[],"relativePath":"interview-question/前端水印功能.md","filePath":"全部文档/前端面试题/场景题/前端水印功能.md","lastUpdated":1696860910000}'),E={name:"interview-question/前端水印功能.md"},y=e("h1",{id:"前端水印功能",tabindex:"-1"},[r("前端水印功能 "),e("a",{class:"header-anchor",href:"#前端水印功能","aria-label":'Permalink to "前端水印功能"'},"​")],-1),i=t('<h2 id="实现水印功能" tabindex="-1">实现水印功能 <a class="header-anchor" href="#实现水印功能" aria-label="Permalink to &quot;实现水印功能&quot;">​</a></h2><h2 id="几种实现方案" tabindex="-1">几种实现方案 <a class="header-anchor" href="#几种实现方案" aria-label="Permalink to &quot;几种实现方案&quot;">​</a></h2><h3 id="基于原图生成水印图片-后端" tabindex="-1">基于原图生成水印图片（后端） <a class="header-anchor" href="#基于原图生成水印图片-后端" aria-label="Permalink to &quot;基于原图生成水印图片（后端）&quot;">​</a></h3><p>这种方案就是将 <strong>原图片</strong> 添加水印之后生成了 <strong>新图片</strong>，后续在前端页面进行展示是后端接口不返回原图片，而是返回带有水印的图片即可。</p><p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9c3d3f291b4f4ad1a8dfc90d97714eed~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image?" alt="image.png"></p><p>这种方式最大的优点就是安全，因为 <strong>水印图片</strong> 是后端生成的，前端只需要负责展示即可，不需考虑多余的问题，且即便在前端页面保存对应图片，拿到的仍然不是原图片。</p><h3 id="基于-dom-实现水印效果-前端" tabindex="-1">基于 DOM 实现水印效果（前端） <a class="header-anchor" href="#基于-dom-实现水印效果-前端" aria-label="Permalink to &quot;基于 DOM 实现水印效果（前端）&quot;">​</a></h3><p>自定义指令钩子非常多，但实际上能使用到的不多，比如最常用的就是 <code>mounted</code>、<code>updated</code>，在这我们只需要通过 <code>mounted</code> 即可实现对应的功能，并且核心代码比较简单。</p><p><strong>核心内容</strong></p><ul><li>创建一个 <code>watermark</code> 的 <code>DOM</code> 节点，即 <code>div</code> 元素，用于包裹对应的 <code>img</code> 便于展示水印内容</li><li>在创建一个 <code>waterbg</code> 的 <code>DOM</code> 节点，即 <code>div</code> 元素 <ul><li>将 <code>waterbg</code> 节点作为 <code>watermark</code> 的 <strong>子节点</strong>，并进行 <strong>绝对定位</strong> 保证 <code>waterbg</code> 在 <strong>最上层显示</strong></li><li>将对应的 <strong>水印标记</strong> 作为 <code>waterbg</code> 节点的 <strong>背景图片</strong> 展示</li><li>为 <code>waterbg</code> 节点设置 <code>pointer-events: none;</code> 实现 <strong>点击穿透</strong></li></ul></li><li>将 <code>watermark</code> 节点通过 <code>insertBefore(...)</code> 插入到 <code>img</code> 标签的前一个位置</li><li>再将 <code>img</code> 标签移动到 <code>watermark</code> 节点节中，这样就保证了新创建的 <code>watermark</code> 节点的位置一定是在原本 <code>img</code> 挂载的位置</li></ul><p><strong>效果和代码如下</strong></p><p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3665bb22644b400a9924b12cc92ca41a~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image?" alt="image.png"></p><div class="language-js vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// main.ts</span></span>\n<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> { createApp } </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;vue&#39;</span></span>\n<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> App </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;./App.vue&#39;</span></span>\n<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> directives </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;./directives&#39;</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#B392F0;">createApp</span><span style="color:#E1E4E8;">(App)</span></span>\n<span class="line"><span style="color:#E1E4E8;">    .</span><span style="color:#B392F0;">use</span><span style="color:#E1E4E8;">(directives)</span></span>\n<span class="line"><span style="color:#E1E4E8;">    .</span><span style="color:#B392F0;">mount</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;#app&#39;</span><span style="color:#E1E4E8;">);</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#6A737D;">// src/directives/index.ts</span></span>\n<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">type</span><span style="color:#E1E4E8;"> { App } </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;vue&#39;</span></span>\n<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> watermark </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;./waterMark&#39;</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F97583;">export</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">default</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">installDirective</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">app</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">App</span><span style="color:#E1E4E8;">) {</span></span>\n<span class="line"><span style="color:#E1E4E8;">    app.</span><span style="color:#B392F0;">directive</span><span style="color:#E1E4E8;">(watermark.name, watermark.directives);</span></span>\n<span class="line"><span style="color:#E1E4E8;">} </span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#6A737D;">// src/directives/waterMark.ts</span></span>\n<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> waterBgImg </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;../assets/water-bg.png&#39;</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">directives</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">any</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> {</span></span>\n<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">mounted</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">el</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">HTMLElement</span><span style="color:#E1E4E8;">) {</span></span>\n<span class="line"><span style="color:#E1E4E8;">        el.</span><span style="color:#B392F0;">onload</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> () </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>\n<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> { </span><span style="color:#79B8FF;">clientWidth</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">clientHeight</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">parentElement</span><span style="color:#E1E4E8;"> } </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> el;</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">waterMark</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">HTMLElement</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> document.</span><span style="color:#B392F0;">createElement</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;div&#39;</span><span style="color:#E1E4E8;">);</span></span>\n<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">waterBg</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">HTMLElement</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> document.</span><span style="color:#B392F0;">createElement</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;div&#39;</span><span style="color:#E1E4E8;">);</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#E1E4E8;">            waterMark.className </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">`water-mark`</span><span style="color:#E1E4E8;">;</span><span style="color:#6A737D;">// 方便自定义展示结果</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">// 创建 waterMark 父元素</span></span>\n<span class="line"><span style="color:#E1E4E8;">            waterMark.</span><span style="color:#B392F0;">setAttribute</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;style&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">`</span></span>\n<span class="line"><span style="color:#9ECBFF;">            display: inline-block;</span></span>\n<span class="line"><span style="color:#9ECBFF;">            overflow: hidden;</span></span>\n<span class="line"><span style="color:#9ECBFF;">            position: relative;</span></span>\n<span class="line"><span style="color:#9ECBFF;">            width: ${</span><span style="color:#E1E4E8;">clientWidth</span><span style="color:#9ECBFF;">}px; </span></span>\n<span class="line"><span style="color:#9ECBFF;">            height: ${</span><span style="color:#E1E4E8;">clientHeight</span><span style="color:#9ECBFF;">}px;`</span><span style="color:#E1E4E8;">);</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">// 创建 waterBg 背景元素</span></span>\n<span class="line"><span style="color:#E1E4E8;">            waterBg.className </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">`water-mark-bg`</span><span style="color:#E1E4E8;">;</span><span style="color:#6A737D;">// 方便自定义展示结果</span></span>\n<span class="line"><span style="color:#E1E4E8;">            waterBg.</span><span style="color:#B392F0;">setAttribute</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;style&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">`</span></span>\n<span class="line"><span style="color:#9ECBFF;">            position: absolute;</span></span>\n<span class="line"><span style="color:#9ECBFF;">            pointer-events: none;</span></span>\n<span class="line"><span style="color:#9ECBFF;">            width: 100%;</span></span>\n<span class="line"><span style="color:#9ECBFF;">            height: 100%;</span></span>\n<span class="line"><span style="color:#9ECBFF;">            opacity: 0.2;</span></span>\n<span class="line"><span style="color:#9ECBFF;">            background-image: url(${</span><span style="color:#E1E4E8;">waterBgImg</span><span style="color:#9ECBFF;">}); </span></span>\n<span class="line"><span style="color:#9ECBFF;">            background-repeat: repeat;`</span><span style="color:#E1E4E8;">);</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">// 为 waterMark 添加对应的子元素</span></span>\n<span class="line"><span style="color:#E1E4E8;">            waterMark.</span><span style="color:#B392F0;">appendChild</span><span style="color:#E1E4E8;">(waterBg);</span></span>\n<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">// 将 waterMark 插入到对应的位置</span></span>\n<span class="line"><span style="color:#E1E4E8;">            parentElement?.</span><span style="color:#B392F0;">insertBefore</span><span style="color:#E1E4E8;">(waterMark, el);</span></span>\n<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">// 将图片元素移动到 waterMark 中</span></span>\n<span class="line"><span style="color:#E1E4E8;">            waterMark.</span><span style="color:#B392F0;">appendChild</span><span style="color:#E1E4E8;">(el);</span></span>\n<span class="line"><span style="color:#E1E4E8;">        }</span></span>\n<span class="line"><span style="color:#E1E4E8;">    }</span></span>\n<span class="line"><span style="color:#E1E4E8;">}</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F97583;">export</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">default</span><span style="color:#E1E4E8;"> {</span></span>\n<span class="line"><span style="color:#E1E4E8;">    name: </span><span style="color:#9ECBFF;">&#39;watermark&#39;</span><span style="color:#E1E4E8;">,</span></span>\n<span class="line"><span style="color:#E1E4E8;">    directives</span></span>\n<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// main.ts</span></span>\n<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> { createApp } </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;vue&#39;</span></span>\n<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> App </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;./App.vue&#39;</span></span>\n<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> directives </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;./directives&#39;</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#6F42C1;">createApp</span><span style="color:#24292E;">(App)</span></span>\n<span class="line"><span style="color:#24292E;">    .</span><span style="color:#6F42C1;">use</span><span style="color:#24292E;">(directives)</span></span>\n<span class="line"><span style="color:#24292E;">    .</span><span style="color:#6F42C1;">mount</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;#app&#39;</span><span style="color:#24292E;">);</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#6A737D;">// src/directives/index.ts</span></span>\n<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">type</span><span style="color:#24292E;"> { App } </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;vue&#39;</span></span>\n<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> watermark </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;./waterMark&#39;</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#D73A49;">export</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">default</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">function</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">installDirective</span><span style="color:#24292E;">(</span><span style="color:#E36209;">app</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">App</span><span style="color:#24292E;">) {</span></span>\n<span class="line"><span style="color:#24292E;">    app.</span><span style="color:#6F42C1;">directive</span><span style="color:#24292E;">(watermark.name, watermark.directives);</span></span>\n<span class="line"><span style="color:#24292E;">} </span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#6A737D;">// src/directives/waterMark.ts</span></span>\n<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> waterBgImg </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;../assets/water-bg.png&#39;</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#D73A49;">const</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">directives</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">any</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> {</span></span>\n<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">mounted</span><span style="color:#24292E;">(</span><span style="color:#E36209;">el</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">HTMLElement</span><span style="color:#24292E;">) {</span></span>\n<span class="line"><span style="color:#24292E;">        el.</span><span style="color:#6F42C1;">onload</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> () </span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;"> {</span></span>\n<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">const</span><span style="color:#24292E;"> { </span><span style="color:#005CC5;">clientWidth</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">clientHeight</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">parentElement</span><span style="color:#24292E;"> } </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> el;</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">const</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">waterMark</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">HTMLElement</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> document.</span><span style="color:#6F42C1;">createElement</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;div&#39;</span><span style="color:#24292E;">);</span></span>\n<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">const</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">waterBg</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">HTMLElement</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> document.</span><span style="color:#6F42C1;">createElement</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;div&#39;</span><span style="color:#24292E;">);</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#24292E;">            waterMark.className </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">`water-mark`</span><span style="color:#24292E;">;</span><span style="color:#6A737D;">// 方便自定义展示结果</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">// 创建 waterMark 父元素</span></span>\n<span class="line"><span style="color:#24292E;">            waterMark.</span><span style="color:#6F42C1;">setAttribute</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;style&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">`</span></span>\n<span class="line"><span style="color:#032F62;">            display: inline-block;</span></span>\n<span class="line"><span style="color:#032F62;">            overflow: hidden;</span></span>\n<span class="line"><span style="color:#032F62;">            position: relative;</span></span>\n<span class="line"><span style="color:#032F62;">            width: ${</span><span style="color:#24292E;">clientWidth</span><span style="color:#032F62;">}px; </span></span>\n<span class="line"><span style="color:#032F62;">            height: ${</span><span style="color:#24292E;">clientHeight</span><span style="color:#032F62;">}px;`</span><span style="color:#24292E;">);</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">// 创建 waterBg 背景元素</span></span>\n<span class="line"><span style="color:#24292E;">            waterBg.className </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">`water-mark-bg`</span><span style="color:#24292E;">;</span><span style="color:#6A737D;">// 方便自定义展示结果</span></span>\n<span class="line"><span style="color:#24292E;">            waterBg.</span><span style="color:#6F42C1;">setAttribute</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;style&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">`</span></span>\n<span class="line"><span style="color:#032F62;">            position: absolute;</span></span>\n<span class="line"><span style="color:#032F62;">            pointer-events: none;</span></span>\n<span class="line"><span style="color:#032F62;">            width: 100%;</span></span>\n<span class="line"><span style="color:#032F62;">            height: 100%;</span></span>\n<span class="line"><span style="color:#032F62;">            opacity: 0.2;</span></span>\n<span class="line"><span style="color:#032F62;">            background-image: url(${</span><span style="color:#24292E;">waterBgImg</span><span style="color:#032F62;">}); </span></span>\n<span class="line"><span style="color:#032F62;">            background-repeat: repeat;`</span><span style="color:#24292E;">);</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">// 为 waterMark 添加对应的子元素</span></span>\n<span class="line"><span style="color:#24292E;">            waterMark.</span><span style="color:#6F42C1;">appendChild</span><span style="color:#24292E;">(waterBg);</span></span>\n<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">// 将 waterMark 插入到对应的位置</span></span>\n<span class="line"><span style="color:#24292E;">            parentElement?.</span><span style="color:#6F42C1;">insertBefore</span><span style="color:#24292E;">(waterMark, el);</span></span>\n<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">// 将图片元素移动到 waterMark 中</span></span>\n<span class="line"><span style="color:#24292E;">            waterMark.</span><span style="color:#6F42C1;">appendChild</span><span style="color:#24292E;">(el);</span></span>\n<span class="line"><span style="color:#24292E;">        }</span></span>\n<span class="line"><span style="color:#24292E;">    }</span></span>\n<span class="line"><span style="color:#24292E;">}</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#D73A49;">export</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">default</span><span style="color:#24292E;"> {</span></span>\n<span class="line"><span style="color:#24292E;">    name: </span><span style="color:#032F62;">&#39;watermark&#39;</span><span style="color:#24292E;">,</span></span>\n<span class="line"><span style="color:#24292E;">    directives</span></span>\n<span class="line"><span style="color:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br></div></div><p><strong>优化实现方式</strong></p><p>在上述的实现方式中，实际上至少有两点可优化的点：</p><ul><li>所有的样式直接以 <strong>字符串</strong> 形式出现在 <code>JavaScript</code> 代码中 <ul><li>可以将对应的静态样式部分处理在 <code>css</code> 中，由 <code>.water-mark</code> 来管理</li></ul></li><li>多余的 <code>waterBg</code> 被创建出来 <ul><li>其实完全没必要单独创建这个节点元素，可以直接基于 <code>.water-mark</code> 对应节点的伪类元素来实现</li></ul></li></ul><p>优化后核心代码如下：</p><div class="language-js vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">/********* src/directives/waterMark.ts ***********/</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">directives</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">any</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> {</span></span>\n<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">mounted</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">el</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">HTMLElement</span><span style="color:#E1E4E8;">) {</span></span>\n<span class="line"><span style="color:#E1E4E8;">    el.</span><span style="color:#B392F0;">onload</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> () </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>\n<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> { </span><span style="color:#79B8FF;">clientWidth</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">clientHeight</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">parentElement</span><span style="color:#E1E4E8;"> } </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> el;</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">waterMark</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">HTMLElement</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> document.</span><span style="color:#B392F0;">createElement</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;div&quot;</span><span style="color:#E1E4E8;">);</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#6A737D;">// 创建 waterMark 父元素</span></span>\n<span class="line"><span style="color:#E1E4E8;">      waterMark.</span><span style="color:#B392F0;">setAttribute</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;style&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">`width: ${</span><span style="color:#E1E4E8;">clientWidth</span><span style="color:#9ECBFF;">}px; height: ${</span><span style="color:#E1E4E8;">clientHeight</span><span style="color:#9ECBFF;">}px;`</span><span style="color:#E1E4E8;">);</span></span>\n<span class="line"><span style="color:#E1E4E8;">      waterMark.className </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">`water-mark`</span><span style="color:#E1E4E8;">; </span><span style="color:#6A737D;">// 方便自定义展示结果</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#6A737D;">// 将 waterMark 插入到对应的位置</span></span>\n<span class="line"><span style="color:#E1E4E8;">      parentElement?.</span><span style="color:#B392F0;">insertBefore</span><span style="color:#E1E4E8;">(waterMark, el);</span></span>\n<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#6A737D;">// 将图片元素移动到 waterMark 中</span></span>\n<span class="line"><span style="color:#E1E4E8;">      waterMark.</span><span style="color:#B392F0;">appendChild</span><span style="color:#E1E4E8;">(el);</span></span>\n<span class="line"><span style="color:#E1E4E8;">    };</span></span>\n<span class="line"><span style="color:#E1E4E8;">  },</span></span>\n<span class="line"><span style="color:#E1E4E8;">};</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F97583;">export</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">default</span><span style="color:#E1E4E8;"> {</span></span>\n<span class="line"><span style="color:#E1E4E8;">  name: </span><span style="color:#9ECBFF;">&quot;watermark&quot;</span><span style="color:#E1E4E8;">,</span></span>\n<span class="line"><span style="color:#E1E4E8;">  directives,</span></span>\n<span class="line"><span style="color:#E1E4E8;">};</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#6A737D;">/********* css 部分代码如下  ***********/</span><span style="color:#E1E4E8;"> </span></span>\n<span class="line"><span style="color:#E1E4E8;">.water</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">mark {</span></span>\n<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">display</span><span style="color:#E1E4E8;">: inline</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">block;</span></span>\n<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">overflow</span><span style="color:#E1E4E8;">: hidden;</span></span>\n<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">position</span><span style="color:#E1E4E8;">: relative;</span></span>\n<span class="line"><span style="color:#E1E4E8;">}</span></span>\n<span class="line"><span style="color:#E1E4E8;">.water</span><span style="color:#F97583;">-</span><span style="color:#B392F0;">mark</span><span style="color:#E1E4E8;">::after {</span></span>\n<span class="line"><span style="color:#E1E4E8;">  pointer</span><span style="color:#F97583;">-</span><span style="color:#B392F0;">events</span><span style="color:#E1E4E8;">: none;</span></span>\n<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">position</span><span style="color:#E1E4E8;">: absolute;</span></span>\n<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">content</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39; &#39;</span><span style="color:#E1E4E8;">;</span></span>\n<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">width</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">100</span><span style="color:#F97583;">%</span><span style="color:#E1E4E8;">;</span></span>\n<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">height</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">100</span><span style="color:#F97583;">%</span><span style="color:#E1E4E8;">;</span></span>\n<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">opacity</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">0.2</span><span style="color:#E1E4E8;">;</span></span>\n<span class="line"><span style="color:#E1E4E8;">  background</span><span style="color:#F97583;">-</span><span style="color:#B392F0;">image</span><span style="color:#E1E4E8;">: </span><span style="color:#B392F0;">url</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;../assets/water-bg.png&quot;</span><span style="color:#E1E4E8;">);</span></span>\n<span class="line"><span style="color:#E1E4E8;">  background</span><span style="color:#F97583;">-</span><span style="color:#B392F0;">repeat</span><span style="color:#E1E4E8;">: repeat;</span></span>\n<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">/********* src/directives/waterMark.ts ***********/</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#D73A49;">const</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">directives</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">any</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> {</span></span>\n<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">mounted</span><span style="color:#24292E;">(</span><span style="color:#E36209;">el</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">HTMLElement</span><span style="color:#24292E;">) {</span></span>\n<span class="line"><span style="color:#24292E;">    el.</span><span style="color:#6F42C1;">onload</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> () </span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;"> {</span></span>\n<span class="line"><span style="color:#24292E;">      </span><span style="color:#D73A49;">const</span><span style="color:#24292E;"> { </span><span style="color:#005CC5;">clientWidth</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">clientHeight</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">parentElement</span><span style="color:#24292E;"> } </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> el;</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#24292E;">      </span><span style="color:#D73A49;">const</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">waterMark</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">HTMLElement</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> document.</span><span style="color:#6F42C1;">createElement</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;div&quot;</span><span style="color:#24292E;">);</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#24292E;">      </span><span style="color:#6A737D;">// 创建 waterMark 父元素</span></span>\n<span class="line"><span style="color:#24292E;">      waterMark.</span><span style="color:#6F42C1;">setAttribute</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;style&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">`width: ${</span><span style="color:#24292E;">clientWidth</span><span style="color:#032F62;">}px; height: ${</span><span style="color:#24292E;">clientHeight</span><span style="color:#032F62;">}px;`</span><span style="color:#24292E;">);</span></span>\n<span class="line"><span style="color:#24292E;">      waterMark.className </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">`water-mark`</span><span style="color:#24292E;">; </span><span style="color:#6A737D;">// 方便自定义展示结果</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#24292E;">      </span><span style="color:#6A737D;">// 将 waterMark 插入到对应的位置</span></span>\n<span class="line"><span style="color:#24292E;">      parentElement?.</span><span style="color:#6F42C1;">insertBefore</span><span style="color:#24292E;">(waterMark, el);</span></span>\n<span class="line"><span style="color:#24292E;">      </span><span style="color:#6A737D;">// 将图片元素移动到 waterMark 中</span></span>\n<span class="line"><span style="color:#24292E;">      waterMark.</span><span style="color:#6F42C1;">appendChild</span><span style="color:#24292E;">(el);</span></span>\n<span class="line"><span style="color:#24292E;">    };</span></span>\n<span class="line"><span style="color:#24292E;">  },</span></span>\n<span class="line"><span style="color:#24292E;">};</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#D73A49;">export</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">default</span><span style="color:#24292E;"> {</span></span>\n<span class="line"><span style="color:#24292E;">  name: </span><span style="color:#032F62;">&quot;watermark&quot;</span><span style="color:#24292E;">,</span></span>\n<span class="line"><span style="color:#24292E;">  directives,</span></span>\n<span class="line"><span style="color:#24292E;">};</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#6A737D;">/********* css 部分代码如下  ***********/</span><span style="color:#24292E;"> </span></span>\n<span class="line"><span style="color:#24292E;">.water</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">mark {</span></span>\n<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">display</span><span style="color:#24292E;">: inline</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">block;</span></span>\n<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">overflow</span><span style="color:#24292E;">: hidden;</span></span>\n<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">position</span><span style="color:#24292E;">: relative;</span></span>\n<span class="line"><span style="color:#24292E;">}</span></span>\n<span class="line"><span style="color:#24292E;">.water</span><span style="color:#D73A49;">-</span><span style="color:#6F42C1;">mark</span><span style="color:#24292E;">::after {</span></span>\n<span class="line"><span style="color:#24292E;">  pointer</span><span style="color:#D73A49;">-</span><span style="color:#6F42C1;">events</span><span style="color:#24292E;">: none;</span></span>\n<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">position</span><span style="color:#24292E;">: absolute;</span></span>\n<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">content</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39; &#39;</span><span style="color:#24292E;">;</span></span>\n<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">width</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">100</span><span style="color:#D73A49;">%</span><span style="color:#24292E;">;</span></span>\n<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">height</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">100</span><span style="color:#D73A49;">%</span><span style="color:#24292E;">;</span></span>\n<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">opacity</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">0.2</span><span style="color:#24292E;">;</span></span>\n<span class="line"><span style="color:#24292E;">  background</span><span style="color:#D73A49;">-</span><span style="color:#6F42C1;">image</span><span style="color:#24292E;">: </span><span style="color:#6F42C1;">url</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;../assets/water-bg.png&quot;</span><span style="color:#24292E;">);</span></span>\n<span class="line"><span style="color:#24292E;">  background</span><span style="color:#D73A49;">-</span><span style="color:#6F42C1;">repeat</span><span style="color:#24292E;">: repeat;</span></span>\n<span class="line"><span style="color:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><h3 id="基于-canvas-实现水印效果-前端" tabindex="-1">基于 Canvas 实现水印效果（前端） <a class="header-anchor" href="#基于-canvas-实现水印效果-前端" aria-label="Permalink to &quot;基于 Canvas 实现水印效果（前端）&quot;">​</a></h3><p>基于 <code>Canvas</code> 实现方式的优点就在于能够动态的设置水印内容，相比于上一种基于固定背景图片的方式更灵活，这种方式也是 <strong>语雀</strong> 在使用的方式，具体效果如下：</p><p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e4abaf90c6664a59837af9ed62d9da55~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image?" alt=""></p><p><strong>核心步骤</strong></p><ul><li>通过 <code>canvas</code> 填充文本，并通过 <code>canvas.toDataURL(&quot;image/png&quot;);</code> 获取到对应的 <code>base64</code> 格式的图片</li><li>将这个 <code>base64</code> 格式的图片作为类名为 <code>water-mark</code> 节点的背景图 <ul><li>利用 <code>background-repeat: repeat;</code> 让这个图重复填充背景即可</li><li>为 <code>water-mark</code> 节点设置 <code>pointer-events: none;</code> 实现 <strong>点击穿透</strong></li><li>利用对应图片的父元素作为 <code>water-mark</code> 节点的相对定位节点，保证绝对定位的 <code>water-mark</code> 节点显式在对应图片之上</li></ul></li></ul><p><strong>效果和代码如下</strong></p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6f9190aa805144858810da50b4aca13b~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image?" alt=""></p><div class="language-js vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">/********* src/directives/waterMark.ts  ***********/</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#6A737D;">// 全局保存 canvas 和 div ，避免重复创建（单例模式）</span></span>\n<span class="line"><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">globalCanvas</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">;</span></span>\n<span class="line"><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">globalWaterMark</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">;</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#6A737D;">// 获取 toDataURL 的结果</span></span>\n<span class="line"><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">getDataUrl</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> ({</span></span>\n<span class="line"><span style="color:#E1E4E8;">  font </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;16px normal&quot;</span><span style="color:#E1E4E8;">,</span></span>\n<span class="line"><span style="color:#E1E4E8;">  fillStyle </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;rgba(180, 180, 180, 0.3)&quot;</span><span style="color:#E1E4E8;">,</span></span>\n<span class="line"><span style="color:#E1E4E8;">  textAlign,</span></span>\n<span class="line"><span style="color:#E1E4E8;">  textBaseline,</span></span>\n<span class="line"><span style="color:#E1E4E8;">  text </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;请勿外传&quot;</span><span style="color:#E1E4E8;">,</span></span>\n<span class="line"><span style="color:#E1E4E8;">}) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>\n<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">rotate</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">20</span><span style="color:#E1E4E8;">;</span></span>\n<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">canvas</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> globalCanvas </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> document.</span><span style="color:#B392F0;">createElement</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;canvas&quot;</span><span style="color:#E1E4E8;">);</span></span>\n<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ctx</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> canvas.</span><span style="color:#B392F0;">getContext</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;2d&quot;</span><span style="color:#E1E4E8;">); </span><span style="color:#6A737D;">// 获取画布上下文</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#E1E4E8;">  ctx.</span><span style="color:#B392F0;">rotate</span><span style="color:#E1E4E8;">((rotate </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> Math.</span><span style="color:#79B8FF;">PI</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">180</span><span style="color:#E1E4E8;">);</span></span>\n<span class="line"><span style="color:#E1E4E8;">  ctx.font </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> font;</span></span>\n<span class="line"><span style="color:#E1E4E8;">  ctx.fillStyle </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> fillStyle;</span></span>\n<span class="line"><span style="color:#E1E4E8;">  ctx.textAlign </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> textAlign </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;left&quot;</span><span style="color:#E1E4E8;">;</span></span>\n<span class="line"><span style="color:#E1E4E8;">  ctx.textBaseline </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> textBaseline </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;middle&quot;</span><span style="color:#E1E4E8;">;</span></span>\n<span class="line"><span style="color:#E1E4E8;">  ctx.</span><span style="color:#B392F0;">fillText</span><span style="color:#E1E4E8;">(text, canvas.width </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">, canvas.height </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">);</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> canvas.</span><span style="color:#B392F0;">toDataURL</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;image/png&quot;</span><span style="color:#E1E4E8;">);</span></span>\n<span class="line"><span style="color:#E1E4E8;">};</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#6A737D;">// 设置水印</span></span>\n<span class="line"><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">setWaterMark</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> (</span><span style="color:#FFAB70;">el</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">HTMLElement</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">binding</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">any</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>\n<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> { </span><span style="color:#79B8FF;">parentElement</span><span style="color:#E1E4E8;"> } </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> el;</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">// 获取对应的 canvas 画布相关的 base64 url</span></span>\n<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">url</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">getDataUrl</span><span style="color:#E1E4E8;">(binding);</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">// 创建 waterMark 父元素</span></span>\n<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">waterMark</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> globalWaterMark </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> document.</span><span style="color:#B392F0;">createElement</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;div&quot;</span><span style="color:#E1E4E8;">);</span></span>\n<span class="line"><span style="color:#E1E4E8;">  waterMark.className </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">`water-mark`</span><span style="color:#E1E4E8;">; </span><span style="color:#6A737D;">// 方便自定义展示结果</span></span>\n<span class="line"><span style="color:#E1E4E8;">  waterMark.</span><span style="color:#B392F0;">setAttribute</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;style&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">`background-image: url(${</span><span style="color:#E1E4E8;">url</span><span style="color:#9ECBFF;">});`</span><span style="color:#E1E4E8;">);</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">// 将对应图片的父容器作为定位元素</span></span>\n<span class="line"><span style="color:#E1E4E8;">  parentElement.</span><span style="color:#B392F0;">setAttribute</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;style&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;position: relative;&quot;</span><span style="color:#E1E4E8;">);</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">// 将图片元素移动到 waterMark 中</span></span>\n<span class="line"><span style="color:#E1E4E8;">  parentElement.</span><span style="color:#B392F0;">appendChild</span><span style="color:#E1E4E8;">(waterMark);</span></span>\n<span class="line"><span style="color:#E1E4E8;">};</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">directives</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">any</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> {</span></span>\n<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">mounted</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">el</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">HTMLElement</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">binding</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">any</span><span style="color:#E1E4E8;">) {</span></span>\n<span class="line"><span style="color:#E1E4E8;">    el.onload </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> setWaterMark.</span><span style="color:#B392F0;">bind</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">, el, binding.value);</span></span>\n<span class="line"><span style="color:#E1E4E8;">  },</span></span>\n<span class="line"><span style="color:#E1E4E8;">};</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F97583;">export</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">default</span><span style="color:#E1E4E8;"> {</span></span>\n<span class="line"><span style="color:#E1E4E8;">  name: </span><span style="color:#9ECBFF;">&quot;watermark&quot;</span><span style="color:#E1E4E8;">,</span></span>\n<span class="line"><span style="color:#E1E4E8;">  directives,</span></span>\n<span class="line"><span style="color:#E1E4E8;">};</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#6A737D;">/*********  css 部分  ***********/</span></span>\n<span class="line"><span style="color:#E1E4E8;">.water</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">mark {</span></span>\n<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">display</span><span style="color:#E1E4E8;">: inline</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">block;</span></span>\n<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">overflow</span><span style="color:#E1E4E8;">: hidden;</span></span>\n<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">position</span><span style="color:#E1E4E8;">: absolute;</span></span>\n<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">left</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">;</span></span>\n<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">top</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">;</span></span>\n<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">width</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">100</span><span style="color:#F97583;">%</span><span style="color:#E1E4E8;">;</span></span>\n<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">height</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">100</span><span style="color:#F97583;">%</span><span style="color:#E1E4E8;">;</span></span>\n<span class="line"><span style="color:#E1E4E8;">  pointer</span><span style="color:#F97583;">-</span><span style="color:#B392F0;">events</span><span style="color:#E1E4E8;">: none;</span></span>\n<span class="line"><span style="color:#E1E4E8;">  background</span><span style="color:#F97583;">-</span><span style="color:#B392F0;">repeat</span><span style="color:#E1E4E8;">: repeat;</span></span>\n<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">/********* src/directives/waterMark.ts  ***********/</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#6A737D;">// 全局保存 canvas 和 div ，避免重复创建（单例模式）</span></span>\n<span class="line"><span style="color:#D73A49;">const</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">globalCanvas</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">;</span></span>\n<span class="line"><span style="color:#D73A49;">const</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">globalWaterMark</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">;</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#6A737D;">// 获取 toDataURL 的结果</span></span>\n<span class="line"><span style="color:#D73A49;">const</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">getDataUrl</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> ({</span></span>\n<span class="line"><span style="color:#24292E;">  font </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;16px normal&quot;</span><span style="color:#24292E;">,</span></span>\n<span class="line"><span style="color:#24292E;">  fillStyle </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;rgba(180, 180, 180, 0.3)&quot;</span><span style="color:#24292E;">,</span></span>\n<span class="line"><span style="color:#24292E;">  textAlign,</span></span>\n<span class="line"><span style="color:#24292E;">  textBaseline,</span></span>\n<span class="line"><span style="color:#24292E;">  text </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;请勿外传&quot;</span><span style="color:#24292E;">,</span></span>\n<span class="line"><span style="color:#24292E;">}) </span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;"> {</span></span>\n<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">const</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">rotate</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">20</span><span style="color:#24292E;">;</span></span>\n<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">const</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">canvas</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> globalCanvas </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> document.</span><span style="color:#6F42C1;">createElement</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;canvas&quot;</span><span style="color:#24292E;">);</span></span>\n<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">const</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ctx</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> canvas.</span><span style="color:#6F42C1;">getContext</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;2d&quot;</span><span style="color:#24292E;">); </span><span style="color:#6A737D;">// 获取画布上下文</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#24292E;">  ctx.</span><span style="color:#6F42C1;">rotate</span><span style="color:#24292E;">((rotate </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> Math.</span><span style="color:#005CC5;">PI</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">180</span><span style="color:#24292E;">);</span></span>\n<span class="line"><span style="color:#24292E;">  ctx.font </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> font;</span></span>\n<span class="line"><span style="color:#24292E;">  ctx.fillStyle </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> fillStyle;</span></span>\n<span class="line"><span style="color:#24292E;">  ctx.textAlign </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> textAlign </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;left&quot;</span><span style="color:#24292E;">;</span></span>\n<span class="line"><span style="color:#24292E;">  ctx.textBaseline </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> textBaseline </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;middle&quot;</span><span style="color:#24292E;">;</span></span>\n<span class="line"><span style="color:#24292E;">  ctx.</span><span style="color:#6F42C1;">fillText</span><span style="color:#24292E;">(text, canvas.width </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3</span><span style="color:#24292E;">, canvas.height </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">);</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> canvas.</span><span style="color:#6F42C1;">toDataURL</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;image/png&quot;</span><span style="color:#24292E;">);</span></span>\n<span class="line"><span style="color:#24292E;">};</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#6A737D;">// 设置水印</span></span>\n<span class="line"><span style="color:#D73A49;">const</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">setWaterMark</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (</span><span style="color:#E36209;">el</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">HTMLElement</span><span style="color:#24292E;">, </span><span style="color:#E36209;">binding</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">any</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;"> {</span></span>\n<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">const</span><span style="color:#24292E;"> { </span><span style="color:#005CC5;">parentElement</span><span style="color:#24292E;"> } </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> el;</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;">// 获取对应的 canvas 画布相关的 base64 url</span></span>\n<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">const</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">url</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">getDataUrl</span><span style="color:#24292E;">(binding);</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;">// 创建 waterMark 父元素</span></span>\n<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">const</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">waterMark</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> globalWaterMark </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> document.</span><span style="color:#6F42C1;">createElement</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;div&quot;</span><span style="color:#24292E;">);</span></span>\n<span class="line"><span style="color:#24292E;">  waterMark.className </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">`water-mark`</span><span style="color:#24292E;">; </span><span style="color:#6A737D;">// 方便自定义展示结果</span></span>\n<span class="line"><span style="color:#24292E;">  waterMark.</span><span style="color:#6F42C1;">setAttribute</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;style&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">`background-image: url(${</span><span style="color:#24292E;">url</span><span style="color:#032F62;">});`</span><span style="color:#24292E;">);</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;">// 将对应图片的父容器作为定位元素</span></span>\n<span class="line"><span style="color:#24292E;">  parentElement.</span><span style="color:#6F42C1;">setAttribute</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;style&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;position: relative;&quot;</span><span style="color:#24292E;">);</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;">// 将图片元素移动到 waterMark 中</span></span>\n<span class="line"><span style="color:#24292E;">  parentElement.</span><span style="color:#6F42C1;">appendChild</span><span style="color:#24292E;">(waterMark);</span></span>\n<span class="line"><span style="color:#24292E;">};</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#D73A49;">const</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">directives</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">any</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> {</span></span>\n<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">mounted</span><span style="color:#24292E;">(</span><span style="color:#E36209;">el</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">HTMLElement</span><span style="color:#24292E;">, </span><span style="color:#E36209;">binding</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">any</span><span style="color:#24292E;">) {</span></span>\n<span class="line"><span style="color:#24292E;">    el.onload </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> setWaterMark.</span><span style="color:#6F42C1;">bind</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">null</span><span style="color:#24292E;">, el, binding.value);</span></span>\n<span class="line"><span style="color:#24292E;">  },</span></span>\n<span class="line"><span style="color:#24292E;">};</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#D73A49;">export</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">default</span><span style="color:#24292E;"> {</span></span>\n<span class="line"><span style="color:#24292E;">  name: </span><span style="color:#032F62;">&quot;watermark&quot;</span><span style="color:#24292E;">,</span></span>\n<span class="line"><span style="color:#24292E;">  directives,</span></span>\n<span class="line"><span style="color:#24292E;">};</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#6A737D;">/*********  css 部分  ***********/</span></span>\n<span class="line"><span style="color:#24292E;">.water</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">mark {</span></span>\n<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">display</span><span style="color:#24292E;">: inline</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">block;</span></span>\n<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">overflow</span><span style="color:#24292E;">: hidden;</span></span>\n<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">position</span><span style="color:#24292E;">: absolute;</span></span>\n<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">left</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">;</span></span>\n<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">top</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">;</span></span>\n<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">width</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">100</span><span style="color:#D73A49;">%</span><span style="color:#24292E;">;</span></span>\n<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">height</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">100</span><span style="color:#D73A49;">%</span><span style="color:#24292E;">;</span></span>\n<span class="line"><span style="color:#24292E;">  pointer</span><span style="color:#D73A49;">-</span><span style="color:#6F42C1;">events</span><span style="color:#24292E;">: none;</span></span>\n<span class="line"><span style="color:#24292E;">  background</span><span style="color:#D73A49;">-</span><span style="color:#6F42C1;">repeat</span><span style="color:#24292E;">: repeat;</span></span>\n<span class="line"><span style="color:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br></div></div><h2 id="使用-mutationobserver-优化" tabindex="-1">使用 MutationObserver 优化 <a class="header-anchor" href="#使用-mutationobserver-优化" aria-label="Permalink to &quot;使用 MutationObserver 优化&quot;">​</a></h2><p>以上提到的两种前端实现方案，都存在一个问题很明显的问题，那就是用于只要用户通过 <strong>开发者调试工具</strong> 来稍微操作一，旧能够导致水印失效：</p><ul><li>删除对应 <code>dom</code> 节点</li><li>设置对应 <code>dom</code> 节点的 <code>css</code> 样式</li></ul><p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b1542a628022405cbb8b2f6dc4dbf661~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image?" alt=""></p><p><a href="https://link.juejin.cn/?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FMutationObserver" title="https://developer.mozilla.org/zh-CN/docs/Web/API/MutationObserver" target="_blank" rel="noreferrer"><strong>MutationObserver</strong></a> 接口提供对 <code>DOM</code> 树监听的能力，它能够监听 <code>DOM</code> 树属性、节点本身、子节点等的变化，于是优化的思路就是使用 <strong>MutationObserver</strong> 去监听外部对应 <code>water-mark</code> 节点的操作，只要监听到了就重新渲染水印效果即可。</p><p><strong>效果和代码</strong></p><blockquote><p>【<strong>注意</strong>】这里最容易踩坑的点就是 <strong>MutationObserver</strong> 中的条件写得不正确的话会导致死循环.</p></blockquote><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/32d95a43a99c42d49cd5e0b4af64fc27~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image?" alt=""></p><div class="language-js vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">/********* src/directives/waterMark.ts  ***********/</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#6A737D;">// 全局保存 canvas 和 div ，避免重复创建（单例模式）</span></span>\n<span class="line"><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">globalCanvas</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">;</span></span>\n<span class="line"><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">globalWaterMark</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">;</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#6A737D;">// watermark 样式</span></span>\n<span class="line"><span style="color:#F97583;">let</span><span style="color:#E1E4E8;"> style </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">`</span></span>\n<span class="line"><span style="color:#9ECBFF;">display: block;</span></span>\n<span class="line"><span style="color:#9ECBFF;">overflow: hidden;</span></span>\n<span class="line"><span style="color:#9ECBFF;">position: absolute;</span></span>\n<span class="line"><span style="color:#9ECBFF;">left: 0;</span></span>\n<span class="line"><span style="color:#9ECBFF;">top: 0;</span></span>\n<span class="line"><span style="color:#9ECBFF;">width: 100%;</span></span>\n<span class="line"><span style="color:#9ECBFF;">height: 100%;</span></span>\n<span class="line"><span style="color:#9ECBFF;">background-repeat: repeat;</span></span>\n<span class="line"><span style="color:#9ECBFF;">pointer-events: none;`</span><span style="color:#E1E4E8;">;</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">getDataUrl</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> ({</span></span>\n<span class="line"><span style="color:#E1E4E8;">  font </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;16px normal&quot;</span><span style="color:#E1E4E8;">,</span></span>\n<span class="line"><span style="color:#E1E4E8;">  fillStyle </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;rgba(180, 180, 180, 0.3)&quot;</span><span style="color:#E1E4E8;">,</span></span>\n<span class="line"><span style="color:#E1E4E8;">  textAlign,</span></span>\n<span class="line"><span style="color:#E1E4E8;">  textBaseline,</span></span>\n<span class="line"><span style="color:#E1E4E8;">  text </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;请勿外传&quot;</span><span style="color:#E1E4E8;">,</span></span>\n<span class="line"><span style="color:#E1E4E8;">}) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>\n<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">rotate</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">20</span><span style="color:#E1E4E8;">;</span></span>\n<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">canvas</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> globalCanvas </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> document.</span><span style="color:#B392F0;">createElement</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;canvas&quot;</span><span style="color:#E1E4E8;">);</span></span>\n<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ctx</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> canvas.</span><span style="color:#B392F0;">getContext</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;2d&quot;</span><span style="color:#E1E4E8;">); </span><span style="color:#6A737D;">// 获取画布上下文</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#E1E4E8;">  ctx.</span><span style="color:#B392F0;">rotate</span><span style="color:#E1E4E8;">((rotate </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> Math.</span><span style="color:#79B8FF;">PI</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">180</span><span style="color:#E1E4E8;">);</span></span>\n<span class="line"><span style="color:#E1E4E8;">  ctx.font </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> font;</span></span>\n<span class="line"><span style="color:#E1E4E8;">  ctx.fillStyle </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> fillStyle;</span></span>\n<span class="line"><span style="color:#E1E4E8;">  ctx.textAlign </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> textAlign </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;left&quot;</span><span style="color:#E1E4E8;">;</span></span>\n<span class="line"><span style="color:#E1E4E8;">  ctx.textBaseline </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> textBaseline </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;middle&quot;</span><span style="color:#E1E4E8;">;</span></span>\n<span class="line"><span style="color:#E1E4E8;">  ctx.</span><span style="color:#B392F0;">fillText</span><span style="color:#E1E4E8;">(text, canvas.width </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">, canvas.height </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">);</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> canvas.</span><span style="color:#B392F0;">toDataURL</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;image/png&quot;</span><span style="color:#E1E4E8;">);</span></span>\n<span class="line"><span style="color:#E1E4E8;">};</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">setWaterMark</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> (</span><span style="color:#FFAB70;">el</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">HTMLElement</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">binding</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">any</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> {}) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>\n<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> { </span><span style="color:#79B8FF;">parentElement</span><span style="color:#E1E4E8;"> } </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> el;</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">// 获取对应的 canvas 画布相关的 base64 url</span></span>\n<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">url</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">getDataUrl</span><span style="color:#E1E4E8;">(binding);</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">// 创建 waterMark 父元素</span></span>\n<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">waterMark</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> globalWaterMark </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> document.</span><span style="color:#B392F0;">createElement</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;div&quot;</span><span style="color:#E1E4E8;">);</span></span>\n<span class="line"><span style="color:#E1E4E8;">  waterMark.className </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">`water-mark`</span><span style="color:#E1E4E8;">; </span><span style="color:#6A737D;">// 方便自定义展示结果</span></span>\n<span class="line"><span style="color:#E1E4E8;">  style </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">`${</span><span style="color:#E1E4E8;">style</span><span style="color:#9ECBFF;">}background-image: url(${</span><span style="color:#E1E4E8;">url</span><span style="color:#9ECBFF;">});`</span><span style="color:#E1E4E8;">;</span></span>\n<span class="line"><span style="color:#E1E4E8;">  waterMark.</span><span style="color:#B392F0;">setAttribute</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;style&quot;</span><span style="color:#E1E4E8;">, style);</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">// 将对应图片的父容器作为定位元素</span></span>\n<span class="line"><span style="color:#E1E4E8;">  parentElement.</span><span style="color:#B392F0;">setAttribute</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;style&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;position: relative;&quot;</span><span style="color:#E1E4E8;">);</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">// 将图片元素移动到 waterMark 中</span></span>\n<span class="line"><span style="color:#E1E4E8;">  parentElement.</span><span style="color:#B392F0;">appendChild</span><span style="color:#E1E4E8;">(waterMark);</span></span>\n<span class="line"><span style="color:#E1E4E8;">};</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#6A737D;">// 监听 DOM 变化</span></span>\n<span class="line"><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">createObserver</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> (</span><span style="color:#FFAB70;">el</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">HTMLElement</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">binding</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">any</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>\n<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">waterMarkEl</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> el.parentElement.</span><span style="color:#B392F0;">querySelector</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;.water-mark&quot;</span><span style="color:#E1E4E8;">);</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">observer</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">MutationObserver</span><span style="color:#E1E4E8;">((</span><span style="color:#FFAB70;">mutationsList</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>\n<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (mutationsList.</span><span style="color:#79B8FF;">length</span><span style="color:#E1E4E8;">) {</span></span>\n<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> { </span><span style="color:#79B8FF;">removedNodes</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">type</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">target</span><span style="color:#E1E4E8;"> } </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> mutationsList[</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">];</span></span>\n<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">currStyle</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> waterMarkEl.</span><span style="color:#B392F0;">getAttribute</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;style&quot;</span><span style="color:#E1E4E8;">);</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#6A737D;">// 证明被删除了</span></span>\n<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (removedNodes[</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">===</span><span style="color:#E1E4E8;"> waterMarkEl) {</span></span>\n<span class="line"><span style="color:#E1E4E8;">        observer.</span><span style="color:#B392F0;">disconnect</span><span style="color:#E1E4E8;">();</span></span>\n<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">init</span><span style="color:#E1E4E8;">(el, binding);</span></span>\n<span class="line"><span style="color:#E1E4E8;">      } </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span></span>\n<span class="line"><span style="color:#E1E4E8;">        type </span><span style="color:#F97583;">===</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;attributes&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&amp;&amp;</span></span>\n<span class="line"><span style="color:#E1E4E8;">        target </span><span style="color:#F97583;">===</span><span style="color:#E1E4E8;"> waterMarkEl </span><span style="color:#F97583;">&amp;&amp;</span></span>\n<span class="line"><span style="color:#E1E4E8;">        currStyle </span><span style="color:#F97583;">!==</span><span style="color:#E1E4E8;"> style</span></span>\n<span class="line"><span style="color:#E1E4E8;">      ) {</span></span>\n<span class="line"><span style="color:#E1E4E8;">        waterMarkEl.</span><span style="color:#B392F0;">setAttribute</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;style&quot;</span><span style="color:#E1E4E8;">, style);</span></span>\n<span class="line"><span style="color:#E1E4E8;">      }</span></span>\n<span class="line"><span style="color:#E1E4E8;">    }</span></span>\n<span class="line"><span style="color:#E1E4E8;">  });</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#E1E4E8;">  observer.</span><span style="color:#B392F0;">observe</span><span style="color:#E1E4E8;">(el.parentElement, {</span></span>\n<span class="line"><span style="color:#E1E4E8;">    childList: </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">,</span></span>\n<span class="line"><span style="color:#E1E4E8;">    attributes: </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">,</span></span>\n<span class="line"><span style="color:#E1E4E8;">    subtree: </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">,</span></span>\n<span class="line"><span style="color:#E1E4E8;">  });</span></span>\n<span class="line"><span style="color:#E1E4E8;">};</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#6A737D;">// 初始化</span></span>\n<span class="line"><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">init</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> (</span><span style="color:#FFAB70;">el</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">HTMLElement</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">binding</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">any</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> {}) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>\n<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">// 设置水印</span></span>\n<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">setWaterMark</span><span style="color:#E1E4E8;">(el, binding.value);</span></span>\n<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">// 启动监控</span></span>\n<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">createObserver</span><span style="color:#E1E4E8;">(el, binding.value);</span></span>\n<span class="line"><span style="color:#E1E4E8;">};</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#6A737D;">// 定义指令配置项</span></span>\n<span class="line"><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">directives</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">any</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> {</span></span>\n<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">mounted</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">el</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">HTMLElement</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">binding</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">any</span><span style="color:#E1E4E8;">) {</span></span>\n<span class="line"><span style="color:#E1E4E8;">    el.onload </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> init.</span><span style="color:#B392F0;">bind</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">, el, binding);</span></span>\n<span class="line"><span style="color:#E1E4E8;">  },</span></span>\n<span class="line"><span style="color:#E1E4E8;">};</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F97583;">export</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">default</span><span style="color:#E1E4E8;"> {</span></span>\n<span class="line"><span style="color:#E1E4E8;">  name: </span><span style="color:#9ECBFF;">&quot;watermark&quot;</span><span style="color:#E1E4E8;">,</span></span>\n<span class="line"><span style="color:#E1E4E8;">  directives,</span></span>\n<span class="line"><span style="color:#E1E4E8;">};</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">/********* src/directives/waterMark.ts  ***********/</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#6A737D;">// 全局保存 canvas 和 div ，避免重复创建（单例模式）</span></span>\n<span class="line"><span style="color:#D73A49;">const</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">globalCanvas</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">;</span></span>\n<span class="line"><span style="color:#D73A49;">const</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">globalWaterMark</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">;</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#6A737D;">// watermark 样式</span></span>\n<span class="line"><span style="color:#D73A49;">let</span><span style="color:#24292E;"> style </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">`</span></span>\n<span class="line"><span style="color:#032F62;">display: block;</span></span>\n<span class="line"><span style="color:#032F62;">overflow: hidden;</span></span>\n<span class="line"><span style="color:#032F62;">position: absolute;</span></span>\n<span class="line"><span style="color:#032F62;">left: 0;</span></span>\n<span class="line"><span style="color:#032F62;">top: 0;</span></span>\n<span class="line"><span style="color:#032F62;">width: 100%;</span></span>\n<span class="line"><span style="color:#032F62;">height: 100%;</span></span>\n<span class="line"><span style="color:#032F62;">background-repeat: repeat;</span></span>\n<span class="line"><span style="color:#032F62;">pointer-events: none;`</span><span style="color:#24292E;">;</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#D73A49;">const</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">getDataUrl</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> ({</span></span>\n<span class="line"><span style="color:#24292E;">  font </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;16px normal&quot;</span><span style="color:#24292E;">,</span></span>\n<span class="line"><span style="color:#24292E;">  fillStyle </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;rgba(180, 180, 180, 0.3)&quot;</span><span style="color:#24292E;">,</span></span>\n<span class="line"><span style="color:#24292E;">  textAlign,</span></span>\n<span class="line"><span style="color:#24292E;">  textBaseline,</span></span>\n<span class="line"><span style="color:#24292E;">  text </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;请勿外传&quot;</span><span style="color:#24292E;">,</span></span>\n<span class="line"><span style="color:#24292E;">}) </span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;"> {</span></span>\n<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">const</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">rotate</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">20</span><span style="color:#24292E;">;</span></span>\n<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">const</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">canvas</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> globalCanvas </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> document.</span><span style="color:#6F42C1;">createElement</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;canvas&quot;</span><span style="color:#24292E;">);</span></span>\n<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">const</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ctx</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> canvas.</span><span style="color:#6F42C1;">getContext</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;2d&quot;</span><span style="color:#24292E;">); </span><span style="color:#6A737D;">// 获取画布上下文</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#24292E;">  ctx.</span><span style="color:#6F42C1;">rotate</span><span style="color:#24292E;">((rotate </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> Math.</span><span style="color:#005CC5;">PI</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">180</span><span style="color:#24292E;">);</span></span>\n<span class="line"><span style="color:#24292E;">  ctx.font </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> font;</span></span>\n<span class="line"><span style="color:#24292E;">  ctx.fillStyle </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> fillStyle;</span></span>\n<span class="line"><span style="color:#24292E;">  ctx.textAlign </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> textAlign </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;left&quot;</span><span style="color:#24292E;">;</span></span>\n<span class="line"><span style="color:#24292E;">  ctx.textBaseline </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> textBaseline </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;middle&quot;</span><span style="color:#24292E;">;</span></span>\n<span class="line"><span style="color:#24292E;">  ctx.</span><span style="color:#6F42C1;">fillText</span><span style="color:#24292E;">(text, canvas.width </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3</span><span style="color:#24292E;">, canvas.height </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">);</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> canvas.</span><span style="color:#6F42C1;">toDataURL</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;image/png&quot;</span><span style="color:#24292E;">);</span></span>\n<span class="line"><span style="color:#24292E;">};</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#D73A49;">const</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">setWaterMark</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (</span><span style="color:#E36209;">el</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">HTMLElement</span><span style="color:#24292E;">, </span><span style="color:#E36209;">binding</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">any</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> {}) </span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;"> {</span></span>\n<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">const</span><span style="color:#24292E;"> { </span><span style="color:#005CC5;">parentElement</span><span style="color:#24292E;"> } </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> el;</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;">// 获取对应的 canvas 画布相关的 base64 url</span></span>\n<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">const</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">url</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">getDataUrl</span><span style="color:#24292E;">(binding);</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;">// 创建 waterMark 父元素</span></span>\n<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">const</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">waterMark</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> globalWaterMark </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> document.</span><span style="color:#6F42C1;">createElement</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;div&quot;</span><span style="color:#24292E;">);</span></span>\n<span class="line"><span style="color:#24292E;">  waterMark.className </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">`water-mark`</span><span style="color:#24292E;">; </span><span style="color:#6A737D;">// 方便自定义展示结果</span></span>\n<span class="line"><span style="color:#24292E;">  style </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">`${</span><span style="color:#24292E;">style</span><span style="color:#032F62;">}background-image: url(${</span><span style="color:#24292E;">url</span><span style="color:#032F62;">});`</span><span style="color:#24292E;">;</span></span>\n<span class="line"><span style="color:#24292E;">  waterMark.</span><span style="color:#6F42C1;">setAttribute</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;style&quot;</span><span style="color:#24292E;">, style);</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;">// 将对应图片的父容器作为定位元素</span></span>\n<span class="line"><span style="color:#24292E;">  parentElement.</span><span style="color:#6F42C1;">setAttribute</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;style&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;position: relative;&quot;</span><span style="color:#24292E;">);</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;">// 将图片元素移动到 waterMark 中</span></span>\n<span class="line"><span style="color:#24292E;">  parentElement.</span><span style="color:#6F42C1;">appendChild</span><span style="color:#24292E;">(waterMark);</span></span>\n<span class="line"><span style="color:#24292E;">};</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#6A737D;">// 监听 DOM 变化</span></span>\n<span class="line"><span style="color:#D73A49;">const</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">createObserver</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (</span><span style="color:#E36209;">el</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">HTMLElement</span><span style="color:#24292E;">, </span><span style="color:#E36209;">binding</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">any</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;"> {</span></span>\n<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">const</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">waterMarkEl</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> el.parentElement.</span><span style="color:#6F42C1;">querySelector</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;.water-mark&quot;</span><span style="color:#24292E;">);</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">const</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">observer</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">MutationObserver</span><span style="color:#24292E;">((</span><span style="color:#E36209;">mutationsList</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;"> {</span></span>\n<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (mutationsList.</span><span style="color:#005CC5;">length</span><span style="color:#24292E;">) {</span></span>\n<span class="line"><span style="color:#24292E;">      </span><span style="color:#D73A49;">const</span><span style="color:#24292E;"> { </span><span style="color:#005CC5;">removedNodes</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">type</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">target</span><span style="color:#24292E;"> } </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> mutationsList[</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">];</span></span>\n<span class="line"><span style="color:#24292E;">      </span><span style="color:#D73A49;">const</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">currStyle</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> waterMarkEl.</span><span style="color:#6F42C1;">getAttribute</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;style&quot;</span><span style="color:#24292E;">);</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#24292E;">      </span><span style="color:#6A737D;">// 证明被删除了</span></span>\n<span class="line"><span style="color:#24292E;">      </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (removedNodes[</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">===</span><span style="color:#24292E;"> waterMarkEl) {</span></span>\n<span class="line"><span style="color:#24292E;">        observer.</span><span style="color:#6F42C1;">disconnect</span><span style="color:#24292E;">();</span></span>\n<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">init</span><span style="color:#24292E;">(el, binding);</span></span>\n<span class="line"><span style="color:#24292E;">      } </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span></span>\n<span class="line"><span style="color:#24292E;">        type </span><span style="color:#D73A49;">===</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;attributes&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&amp;&amp;</span></span>\n<span class="line"><span style="color:#24292E;">        target </span><span style="color:#D73A49;">===</span><span style="color:#24292E;"> waterMarkEl </span><span style="color:#D73A49;">&amp;&amp;</span></span>\n<span class="line"><span style="color:#24292E;">        currStyle </span><span style="color:#D73A49;">!==</span><span style="color:#24292E;"> style</span></span>\n<span class="line"><span style="color:#24292E;">      ) {</span></span>\n<span class="line"><span style="color:#24292E;">        waterMarkEl.</span><span style="color:#6F42C1;">setAttribute</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;style&quot;</span><span style="color:#24292E;">, style);</span></span>\n<span class="line"><span style="color:#24292E;">      }</span></span>\n<span class="line"><span style="color:#24292E;">    }</span></span>\n<span class="line"><span style="color:#24292E;">  });</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#24292E;">  observer.</span><span style="color:#6F42C1;">observe</span><span style="color:#24292E;">(el.parentElement, {</span></span>\n<span class="line"><span style="color:#24292E;">    childList: </span><span style="color:#005CC5;">true</span><span style="color:#24292E;">,</span></span>\n<span class="line"><span style="color:#24292E;">    attributes: </span><span style="color:#005CC5;">true</span><span style="color:#24292E;">,</span></span>\n<span class="line"><span style="color:#24292E;">    subtree: </span><span style="color:#005CC5;">true</span><span style="color:#24292E;">,</span></span>\n<span class="line"><span style="color:#24292E;">  });</span></span>\n<span class="line"><span style="color:#24292E;">};</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#6A737D;">// 初始化</span></span>\n<span class="line"><span style="color:#D73A49;">const</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">init</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (</span><span style="color:#E36209;">el</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">HTMLElement</span><span style="color:#24292E;">, </span><span style="color:#E36209;">binding</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">any</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> {}) </span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;"> {</span></span>\n<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;">// 设置水印</span></span>\n<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">setWaterMark</span><span style="color:#24292E;">(el, binding.value);</span></span>\n<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;">// 启动监控</span></span>\n<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">createObserver</span><span style="color:#24292E;">(el, binding.value);</span></span>\n<span class="line"><span style="color:#24292E;">};</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#6A737D;">// 定义指令配置项</span></span>\n<span class="line"><span style="color:#D73A49;">const</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">directives</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">any</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> {</span></span>\n<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">mounted</span><span style="color:#24292E;">(</span><span style="color:#E36209;">el</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">HTMLElement</span><span style="color:#24292E;">, </span><span style="color:#E36209;">binding</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">any</span><span style="color:#24292E;">) {</span></span>\n<span class="line"><span style="color:#24292E;">    el.onload </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> init.</span><span style="color:#6F42C1;">bind</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">null</span><span style="color:#24292E;">, el, binding);</span></span>\n<span class="line"><span style="color:#24292E;">  },</span></span>\n<span class="line"><span style="color:#24292E;">};</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#D73A49;">export</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">default</span><span style="color:#24292E;"> {</span></span>\n<span class="line"><span style="color:#24292E;">  name: </span><span style="color:#032F62;">&quot;watermark&quot;</span><span style="color:#24292E;">,</span></span>\n<span class="line"><span style="color:#24292E;">  directives,</span></span>\n<span class="line"><span style="color:#24292E;">};</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br></div></div>',35);const F=s(E,[["render",function(s,e,r,t,c,E){const F=n("ArticleMetadata"),b=n("ClientOnly");return a(),l("div",null,[y,p(b,null,{default:o((()=>[p(F)])),_:1}),i])}]]);export{c as __pageData,F as default};
