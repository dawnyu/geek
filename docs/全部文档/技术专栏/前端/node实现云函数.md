---
layout: Article
title: nodeå®ç°äº‘å‡½æ•°
date: 2023/10/01
tags: Node
category: æŠ€æœ¯ä¸“æ 
preview: /common/62.jpg
intro: äº‘å‡½æ•°æ˜¯ä¸€ç§æ— æœåŠ¡å™¨è®¡ç®—æ¨¡å‹ï¼Œå®ƒå…è®¸ä½ åœ¨éœ€è¦æ—¶è¿è¡Œä»£ç ï¼Œè€Œæ— éœ€ç®¡ç†æœåŠ¡å™¨çš„åŸºç¡€æ¶æ„ã€‚å®ƒé€‚ç”¨äºå„ç§åœºæ™¯ï¼ŒåŒ…æ‹¬äº‹ä»¶é©±åŠ¨å‹çš„ä»»åŠ¡ï¼Œå¦‚å“åº” HTTP è¯·æ±‚ã€å¤„ç†é˜Ÿåˆ—ç­‰ã€‚
---

# nodeå®ç°äº‘å‡½æ•°


äº‘å‡½æ•°æ˜¯ä¸€ç§æ— æœåŠ¡å™¨è®¡ç®—æ¨¡å‹ï¼Œå®ƒå…è®¸ä½ åœ¨éœ€è¦æ—¶è¿è¡Œä»£ç ï¼Œè€Œæ— éœ€ç®¡ç†æœåŠ¡å™¨çš„åŸºç¡€æ¶æ„ã€‚å®ƒé€‚ç”¨äºå„ç§åœºæ™¯ï¼ŒåŒ…æ‹¬äº‹ä»¶é©±åŠ¨å‹çš„ä»»åŠ¡ï¼Œå¦‚å“åº” HTTP è¯·æ±‚ã€å¤„ç†é˜Ÿåˆ—ç­‰ã€‚
ä¸¾ä¸ªğŸŒ°ï¼š

```javascript
// ç¤ºä¾‹ï¼šç®€å•çš„äº‘å‡½æ•°
exports.handler = async (event) => {
  const message = "ç¬¬ä¸€ä¸ªäº‘å‡½æ•°";
  return {
    statusCode: 200,
    body: { message, event },
  };
};
```

# å¸¸è§çš„äº‘å¼€å‘æ–¹å¼

- å°ç¨‹åºäº‘å¼€å‘
- è…¾è®¯äº‘serverless
- BFFæœåŠ¡ç¼–æ’ç­‰

# ä¸æƒ³èŠ±é’±æ€ä¹ˆæï¼Ÿ

è‡ªå·±æ’¸ä¸€ä¸ªä¸å°±å¾—äº†ğŸ˜~

## å…ˆäº†è§£ä¸‹æ²™ç®±

æ²™ç®±æ˜¯ä¸€ä¸ªè®¡ç®—æœºå®‰å…¨æ¦‚å¿µï¼Œç”¨äºéš”ç¦»å’Œä¿æŠ¤ä¸€ä¸ªç¨‹åºæˆ–ä¸€æ®µä»£ç ä¸å—å…¶ä»–ç¨‹åºæˆ–ç³»ç»Ÿçš„å½±å“ï¼Œä»¥ç¡®ä¿å…¶å®‰å…¨æ€§å’Œç¨³å®šæ€§ã€‚æ²™ç®±æŠ€æœ¯é€šå¸¸è¢«ç”¨æ¥è¿è¡Œä¸å—ä¿¡ä»»çš„ä»£ç ï¼Œå¦‚ç”¨æˆ·æäº¤çš„è„šæœ¬æˆ–ç¬¬ä¸‰æ–¹æ’ä»¶ï¼ŒåŒæ—¶é™åˆ¶å…¶å¯¹ç³»ç»Ÿå’Œèµ„æºçš„è®¿é—®æƒé™ã€‚

1. **éš”ç¦»æ€§ï¼š** æ²™ç®±é€šè¿‡åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„æ‰§è¡Œç¯å¢ƒï¼Œå°†è¿è¡Œçš„ä»£ç ä¸ä¸»ç³»ç»Ÿæˆ–å…¶ä»–ä»£ç éš”ç¦»å¼€æ¥ã€‚è¿™æ„å‘³ç€åœ¨æ²™ç®±ä¸­è¿è¡Œçš„ä»£ç æ— æ³•ç›´æ¥è®¿é—®ä¸»ç³»ç»Ÿçš„èµ„æºæˆ–å…¶ä»–è¿›ç¨‹çš„æ•°æ®ã€‚
2. **èµ„æºé™åˆ¶ï¼š** æ²™ç®±å¯ä»¥å¯¹è¿è¡Œçš„ä»£ç æ–½åŠ èµ„æºé™åˆ¶ï¼Œä¾‹å¦‚å†…å­˜ã€CPU ä½¿ç”¨é‡å’Œæ–‡ä»¶ç³»ç»Ÿè®¿é—®æƒé™ã€‚è¿™æœ‰åŠ©äºé˜²æ­¢ä»£ç è€—å°½ç³»ç»Ÿèµ„æºæˆ–æ‰§è¡Œæ¶æ„æ“ä½œã€‚
3. **æƒé™æ§åˆ¶ï¼š** æ²™ç®±å¯ä»¥æ ¹æ®éœ€è¦å¯¹ä»£ç çš„æƒé™è¿›è¡Œç²¾ç»†çš„æ§åˆ¶ã€‚è¿™æ„å‘³ç€ä½ å¯ä»¥æŒ‡å®šå“ªäº›ç³»ç»Ÿèµ„æºå’ŒåŠŸèƒ½å¯ç”¨äºè¿è¡Œçš„ä»£ç ï¼Œå“ªäº›ä¸å¯ç”¨ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥é™åˆ¶ç½‘ç»œè®¿é—®æˆ–æ–‡ä»¶è®¿é—®æƒé™ã€‚
4. **é”™è¯¯éš”ç¦»ï¼š** å¦‚æœåœ¨æ²™ç®±ä¸­è¿è¡Œçš„ä»£ç å‘ç”Ÿé”™è¯¯æˆ–å´©æºƒï¼Œå®ƒé€šå¸¸ä¸ä¼šå½±å“åˆ°ä¸»ç³»ç»Ÿæˆ–å…¶ä»–ä»£ç ã€‚æ²™ç®±æä¾›äº†é”™è¯¯éš”ç¦»ï¼Œç¡®ä¿é—®é¢˜å±€é™åœ¨æ²™ç®±å†…éƒ¨ã€‚
5. **å®‰å…¨æ€§ï¼š** æ²™ç®±ç”¨äºè¿è¡Œä¸å—ä¿¡ä»»çš„ä»£ç ï¼Œä»¥å‡å°‘æ½œåœ¨çš„å®‰å…¨æ¼æ´å’Œæ”»å‡»ã€‚é€šè¿‡é™åˆ¶ä»£ç çš„è®¿é—®æƒé™ï¼Œå¯ä»¥é™ä½æ½œåœ¨é£é™©ã€‚
6. **å¤šç”¨é€”æ€§ï¼š** æ²™ç®±ä¸ä»…ç”¨äºè¿è¡Œä¸å—ä¿¡ä»»çš„ä»£ç ï¼Œè¿˜å¯ä»¥ç”¨äºæµ‹è¯•ã€è°ƒè¯•å’Œéš”ç¦»åº”ç”¨ç¨‹åºçš„ä¸åŒéƒ¨åˆ†ã€‚

## å‡ ç§å®ç°æ²™ç®±ç¯å¢ƒçš„æ–¹æ³•

**vm**
vmæ˜¯nodeå†…ç½®æ¨¡å—ä¹‹ä¸€ï¼Œç”¨äºåˆ›å»ºè™šæ‹Ÿæœºç¯å¢ƒï¼Œä»¥ä¾¿åœ¨å…¶ä¸­è¿è¡Œ JavaScript ä»£ç ã€‚è™šæ‹Ÿæœºç¯å¢ƒæä¾›äº†éš”ç¦»å’Œå®‰å…¨æ€§ï¼Œå…è®¸ä½ åœ¨ä¸æ±¡æŸ“å½“å‰ Node.js è¿›ç¨‹çš„å…¨å±€ç¯å¢ƒçš„æƒ…å†µä¸‹æ‰§è¡Œä»£ç ã€‚ï¼›
ç›¸å¯¹äºevalï¼ŒFunctionæ¥è¯´ï¼Œå®‰å…¨æ€§ä¹Ÿæ›´å¥½ä¸€ç‚¹ï¼›

```javascript
eval('1+2') // 3
func = new Function('a', 'b', 'return a+b')
func(1, 2)// 3

// ä½¿ç”¨vm
const vm = require('vm');
const context = {
  x: 10,
  y: 20
};
const code = `
  const result = x + y;
  result;
`;
const result = vm.runInNewContext(code, context);
```

VMå¸¸ç”¨çš„apiï¼š

1. **vm.createContext(sandbox)**: åˆ›å»ºä¸€ä¸ªæ–°çš„ä¸Šä¸‹æ–‡å¯¹è±¡ï¼Œå¯ç”¨äºåœ¨è™šæ‹Ÿæœºä¸­æ‰§è¡Œä»£ç ã€‚**sandbox** å‚æ•°æ˜¯ä¸€ä¸ªå¯é€‰çš„å¯¹è±¡ï¼Œå®ƒä¼šè¢«æ³¨å…¥åˆ°è™šæ‹Ÿæœºçš„å…¨å±€ä½œç”¨åŸŸä¸­ï¼Œå¯ä»¥åœ¨å…¶ä¸­è®¿é—®å¯¹è±¡çš„å±æ€§å’Œæ–¹æ³•ã€‚
2. **vm.runInContext(code, context, options)**: åœ¨æŒ‡å®šçš„ä¸Šä¸‹æ–‡ç¯å¢ƒä¸­æ‰§è¡Œ JavaScript ä»£ç ã€‚**code** å‚æ•°æ˜¯è¦æ‰§è¡Œçš„ä»£ç å­—ç¬¦ä¸²ï¼Œ**context** å‚æ•°æ˜¯ç”± **vm.createContext** åˆ›å»ºçš„ä¸Šä¸‹æ–‡å¯¹è±¡ã€‚**options** å‚æ•°æ˜¯ä¸€ä¸ªå¯é€‰çš„é…ç½®ï¼Œå¯å‚è€ƒå®˜ç½‘ï¼›
3. **vm.runInThisContext(code, options)**: åœ¨å½“å‰ä¸Šä¸‹æ–‡ç¯å¢ƒä¸­æ‰§è¡Œ JavaScript ä»£ç ã€‚ä¸éœ€è¦æŒ‡å®šä¸Šä¸‹æ–‡å¯¹è±¡ï¼Œä»£ç å°†åœ¨å½“å‰ç¯å¢ƒä¸­æ‰§è¡Œã€‚

**runInThisContext**ä¼šåœ¨å½“å‰ä¸Šä¸‹æ–‡ä¸­æ‰§è¡ŒJavaScript ä»£ç ï¼Œèƒ½å¤Ÿè®¿é—®å…¨å±€å˜é‡å’Œå…¨å±€å‡½æ•°ã€‚
ä¸€èˆ¬ç”¨äºåŠ¨æ€åŠ è½½ï¼Œæ¯”å¦‚ï¼š

```javascript
const code = fs.readFileSync('externalScript.js', 'utf8'); 
vm.runInThisContext(code);
```

4. **vm.runInNewContext(code, sandbox, options)**: åœ¨æ–°çš„ä¸Šä¸‹æ–‡ç¯å¢ƒä¸­æ‰§è¡Œ JavaScript ä»£ç ã€‚ä¸ **runInContext** ç±»ä¼¼ï¼Œä½†ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ä¸Šä¸‹æ–‡ç¯å¢ƒï¼Œè€Œä¸æ˜¯åœ¨ç°æœ‰çš„ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œã€‚

ä»¥ä¸Šéƒ½æ˜¯ç›´æ¥æ‰§è¡Œï¼Œä¸ä¼šè¿”å›ç¼–è¯‘åçš„ä»£ç ï¼›ä¸‹é¢å‡ ä¸ªapiæ˜¯å…ˆç¼–è¯‘åï¼Œå¯ä»¥åœ¨ç¨‹åºä¸­å¤šæ¬¡æ‰§è¡Œï¼›

5. **vm.createScript(code, options)**: åˆ›å»ºä¸€ä¸ª **Script** å¯¹è±¡ï¼Œè¯¥å¯¹è±¡åŒ…å«è¦æ‰§è¡Œçš„ JavaScript ä»£ç ã€‚**code** å‚æ•°æ˜¯ä»£ç å­—ç¬¦ä¸²ï¼Œ**options** å‚æ•°æ˜¯ä¸€ä¸ªå¯é€‰çš„é€‰é¡¹å¯¹è±¡ã€‚
6. **Script.runInContext(contextifiedSandbox, options)**: åœ¨æŒ‡å®šçš„ä¸Šä¸‹æ–‡ç¯å¢ƒä¸­æ‰§è¡Œ **Script** å¯¹è±¡ä¸­åŒ…å«çš„ä»£ç ã€‚

```javascript
const script = vm1.createScript(`var a = 1;a;`);
const content = vm1.createContext({});
const result = script.runInContext(content);
```

7. **Script.runInNewContext(sandbox, options)**: åœ¨æ–°çš„ä¸Šä¸‹æ–‡ç¯å¢ƒä¸­æ‰§è¡Œ **Script** å¯¹è±¡ä¸­åŒ…å«çš„ä»£ç ã€‚
8. **Script.runInThisContext(options)**: åœ¨å½“å‰ä¸Šä¸‹æ–‡ç¯å¢ƒä¸­æ‰§è¡Œ **Script** å¯¹è±¡ä¸­åŒ…å«çš„ä»£ç ã€‚

- ä¼˜ç‚¹ï¼š
  - ç®€å•ï¼Œä¸éœ€è¦é¢å¤–çš„ä¾èµ–ã€‚
  - é€‚ç”¨äºä¸€äº›åŸºæœ¬çš„éš”ç¦»éœ€æ±‚ã€‚
- ç¼ºç‚¹ï¼š
  - å®‰å…¨æ€§æœ‰é™ï¼Œä¸èƒ½æä¾›é«˜çº§çš„éš”ç¦»ï¼›

æ¯”å¦‚è¿™æ®µä»£ç ï¼š

```javascript
const code = `const fs = require('fs'); const data = fs.readFileSync('/etc/passwd', 'utf8');console.log(data);`;
vm.runInContext(evilCode, context);
```

**vm2**
**vm2** æ˜¯å¼€æºç¤¾åŒºæä¾›çš„ä¸€ä¸ªåº“ï¼Œå®ƒåŸºäºvmåœ¨ Node.js ä¸­åˆ›å»ºä¸€ä¸ªéš”ç¦»çš„ JavaScript æ‰§è¡Œç¯å¢ƒï¼Œé€šè¿‡es6æ–°å¢çš„ä»£ç†ï¼ˆProxyï¼‰æœºåˆ¶ï¼Œæ¥æ‹¦æˆªå¯¹å¤–éƒ¨å±æ€§çš„è®¿é—®ï¼ŒåŒæ—¶é™åˆ¶å¯¹æ•æ„Ÿèµ„æºçš„è®¿é—®ï¼Œå¯ä»¥è‡ªå®šä¹‰å…¨å±€å¯¹è±¡ï¼Œæä¾›å®‰å…¨é…ç½®å’Œé”™è¯¯å¤„ç†æ¥æé«˜ä»£ç çš„å®‰å…¨æ€§å’Œéš”ç¦»æ€§ã€‚
vm2 æä¾›3ä¸ªç±»ï¼š
**VMï¼š**å…¶ä¸­**VM**åªæ”¯æŒç®€å•çš„JavaScriptä»£ç æ‰§è¡Œï¼Œä¸æ”¯æŒrequireï¼Œæ‰€ä»¥VMä¸æ”¯æŒCommonJSæ¨¡å—åŠ è½½ã€‚
**NodeVMï¼š**è¿™æ˜¯ **vm2** çš„æ ¸å¿ƒç±»ï¼Œç”¨äºåˆ›å»ºä¸€ä¸ªæ²™ç®±ç¯å¢ƒã€‚
**VMScript**ï¼šç”¨äºé¢„ç¼–è¯‘ JavaScript ä»£ç çš„ç±»ã€‚
**NodeVMæ ¸å¿ƒæ–¹æ³•ï¼š**

1. **vm.run(code: string)**ï¼šåœ¨æ²™ç®±ç¯å¢ƒä¸­æ‰§è¡Œ JavaScript ä»£ç ï¼Œå¹¶è¿”å›æ‰§è¡Œç»“æœã€‚

```javascript
const result = vm.run('console.log("Hello from sandbox!");');
```

2. **vm.runScript(script: VMScript)**ï¼šè¿è¡Œä¸€ä¸ªé¢„ç¼–è¯‘çš„ **VMScript** å¯¹è±¡ï¼Œå¯ä»¥æé«˜æ‰§è¡Œæ•ˆç‡ã€‚

```javascript
const script = new VMScript('console.log("Hello from script!");');
const result = vm.runScript(script);
```

3. **vm.freeze(object: any, name: string)**ï¼šå†»ç»“ä¸€ä¸ªå¯¹è±¡ï¼Œé˜»æ­¢å…¶åœ¨æ²™ç®±ä¸­è¢«ä¿®æ”¹ã€‚

```javascript
const obj = { value: 42 };
vm.freeze(obj, 'obj');
```

4. **vm.unfreeze(name: string)**ï¼šè§£å†»è¢«å†»ç»“çš„å¯¹è±¡ï¼Œå…è®¸å…¶åœ¨æ²™ç®±ä¸­è¢«ä¿®æ”¹ã€‚

```javascript
vm.unfreeze('obj');
```

- **ä¼˜ç‚¹ï¼š**

1. **ä¸Šä¸‹æ–‡éš”ç¦»**ï¼š**vm2** ä½¿ç”¨å†…ç½® **vm** æ¨¡å—æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„ä¸Šä¸‹æ–‡æ‰§è¡Œç¯å¢ƒï¼Œä¸å½“å‰ Node.js åº”ç”¨ç¨‹åºçš„å…¨å±€ä¸Šä¸‹æ–‡å®Œå…¨éš”ç¦»ã€‚
2. **å®‰å…¨æ²™ç®±é…ç½®**ï¼šé€šè¿‡é™åˆ¶è®¿é—® Node.js æ ¸å¿ƒæ¨¡å—ã€ç³»ç»Ÿæ¨¡å—å’Œä¸€äº›æ•æ„Ÿèµ„æºæ¥åˆ›å»ºæ²™ç®±ç¯å¢ƒã€‚ä¸èƒ½ç›´æ¥è®¿é—®æ–‡ä»¶ç³»ç»Ÿã€ç½‘ç»œã€æ“ä½œç³»ç»Ÿå‘½ä»¤ç­‰æ•æ„ŸåŠŸèƒ½ï¼Œä»è€Œæé«˜äº†å®‰å…¨æ€§ã€‚ä½ å¯ä»¥é€‰æ‹©æ˜¯å¦å…è®¸ä»£ç è®¿é—®æŸäº›å…¨å±€å¯¹è±¡ã€è®¾ç½®æ‰§è¡Œæ—¶é—´é™åˆ¶ã€é™åˆ¶å†…å­˜ä½¿ç”¨ç­‰ã€‚
3. **è‡ªå®šä¹‰å…¨å±€å¯¹è±¡**ï¼š é™åˆ¶äº†è®¿é—®æ ¸å¿ƒæ¨¡å—å’Œç³»ç»Ÿèµ„æºï¼Œä½†å®ƒå…è®¸ä½ å®šä¹‰è‡ªå·±çš„å…¨å±€å¯¹è±¡ï¼Œä»¥ä¾›æ²™ç®±ä¸­çš„ä»£ç ä½¿ç”¨ã€‚
4. **é”™è¯¯å¤„ç†**ï¼šæä¾›é”™è¯¯å¤„ç†æœºåˆ¶ï¼Œå¯ä»¥æ•è·æ²™ç®±ä¸­çš„å¼‚å¸¸å¹¶è¿”å›ç»™ä¸»ç¨‹åºï¼Œä¾¿äºåšé”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•ã€‚
5. **æ€§èƒ½ä¼˜åŒ–**ï¼šé€šè¿‡ä»£ç é¢„ç¼–è¯‘å’Œç¼“å­˜ï¼Œæ¥æé«˜ä»£ç æ‰§è¡Œçš„æ€§èƒ½ã€‚

- **ç¼ºç‚¹ï¼š**

1. **ä¸é€‚åˆé«˜æ€§èƒ½åº”ç”¨**ï¼šä¾‹å¦‚æ¸¸æˆå¼•æ“æˆ–é«˜ååé‡çš„æœåŠ¡å™¨åº”ç”¨ï¼Œæ›´é€‚åˆç›´æ¥æ‰§è¡Œä»£ç ã€‚
2. **æ— æ³•å®Œå…¨éš”ç¦»**ï¼šè™½ç„¶ **vm2** æä¾›äº†ä¸€å®šç¨‹åº¦çš„éš”ç¦»æ€§ï¼Œä½†å®ƒä»ç„¶æ— æ³•å®Œå…¨éš”ç¦»ä»£ç ã€‚ä¸€äº›å…¨å±€å¯¹è±¡å’Œå˜é‡ä»ç„¶å¯ä»¥åœ¨æ²™ç®±ä¸­è®¿é—®ã€‚

**isolated-vmï¼š**
è¿™ä¸ªnpmåº“ä¹Ÿæ˜¯vm2ä½œè€…å¼€å‘çš„ï¼Œä½œè€…è®¤ä¸ºvm2ç°åœ¨è¶Šæ¥è¶Šéš¾ç»´æŠ¤ï¼Œå·²ç»åˆ°äº†ä¸å¾—ä¸ç»ˆæ­¢é¡¹ç›®çš„åœ°æ­¥ ğŸ¤£ğŸ¤£

> ![](https://cdn.nlark.com/yuque/0/2023/jpeg/459613/1694576156716-7e2c9f1c-b2cf-4eeb-9a99-067d559b62f7.jpeg#averageHue=%23382923&clientId=u6594667b-4e02-4&from=paste&height=40&id=u8474f9a0&originHeight=460&originWidth=460&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=uf33c09ad-bca0-40b1-8cc5-2319a0a655e&title=&width=40)ï¼šUnfortunately, the growing complexity of Node has brought us to a crossroads. We now find ourselves facing an escape so complicated that fixing it seems impossible. And this isn't about one isolated issue. Recent reports have highlighted that sustaining this project in its current form is not viable in the long term.

[ä¼ é€é—¨]()

- ä¼˜ç‚¹ï¼š
  - æä¾›æ›´é«˜çº§çš„éš”ç¦»å’Œå®‰å…¨æ€§ï¼Œå¯ä»¥åœ¨ä¸åŒçš„ V8 ä¸Šä¸‹æ–‡ä¸­è¿è¡Œä»£ç ã€‚
  - å…·æœ‰æ›´å¼ºå¤§çš„éš”ç¦»ï¼Œå¯ä»¥é™åˆ¶å¯¹æ¨¡å—å’Œå…¨å±€å¯¹è±¡çš„è®¿é—®ã€‚
  - æ›´é€‚åˆäºè¿è¡Œä¸å—ä¿¡ä»»çš„ä»£ç ã€‚
- ç¼ºç‚¹ï¼š
  - è¾ƒå¤æ‚ï¼Œå­¦ä¹ æ›²çº¿è¾ƒé™¡ã€‚
  - æ€§èƒ½å¼€é”€è¾ƒå¤§ã€‚

**Dockerï¼š**

- ä¼˜ç‚¹ï¼š
  - æä¾›äº†å®Œå…¨çš„å®¹å™¨éš”ç¦»ï¼Œå¯ä»¥è¿è¡Œæ•´ä¸ªåº”ç”¨ç¨‹åºç¯å¢ƒã€‚
  - é€‚ç”¨äºè¿è¡Œä¸å—ä¿¡ä»»çš„ä»£ç ä»¥åŠå…¶ä»–åº”ç”¨ç¨‹åºçš„éš”ç¦»éœ€æ±‚ã€‚
- ç¼ºç‚¹ï¼š
  - è¾ƒé‡é‡çº§ï¼Œéœ€è¦é¢å¤–çš„ç³»ç»Ÿèµ„æºã€‚
  - å¯¹äºç®€å•çš„éš”ç¦»éœ€æ±‚å¯èƒ½è¿‡äºå¤æ‚

## åŸºäºvm2å¼€å‘ä¸ªäº‘å‡½æ•°

### å…ˆçœ‹ä¸ªå°ä¾‹å­

å†å›åˆ°å¼€ç¯‡è¯´åˆ°çš„é‚£ä¸ªä¾‹å­ï¼š

```javascript
// ç¤ºä¾‹ï¼šç®€å•çš„äº‘å‡½æ•°
exports.handler = async (event) => {
  const message = "ç¬¬ä¸€ä¸ªäº‘å‡½æ•°";
  return {
    statusCode: 200,
    body: { message, event },
  };
};
```

ä¸‹é¢æ˜¯å®ç°ä»¥ä¸Šä¾‹å­çš„code

```typescript
const Koa = require('koa');
const KoaStatic = require('koa-static');
const Router = require('koa-router');
const bodyParser = require('koa-bodyparser');
const path = require('path');

const { NodeVM } = require('vm2');

const vm = new NodeVM({
  // wrapper: 'none',
});

const app = new Koa();
const router = new Router();

router.post('/cloud/test', async function (ctx) {
  const { script } = ctx.request.body;
  const a = vm.run(script);
  ctx.body = { result: a.handler() };
});

const serve = KoaStatic(path.join(__dirname, './public'));
app.use(serve);
app.use(bodyParser());
app.use(router.routes()).use(router.allowedMethods());
app.listen(8003);

```

ä½¿ç”¨postmanæµ‹è¯•ï¼Œå¯ä»¥æ­£å¸¸æ‰§è¡Œï¼š
![image.png](https://cdn.geekbuluo.com/blog/20231010/e0ed49.png)

### å®ç°ä¸€ä¸ªåŠŸèƒ½ç›¸å¯¹å®Œå–„çš„äº‘å‡½æ•°æœåŠ¡

![](https://cdn.geekbuluo.com/blog/20231010/202e04.png)

1. **å…ˆæ•´ä¸€ä¸ªäº‘å‡½æ•°æ¨¡ç‰ˆ**

å…³é”®æ­¥éª¤ï¼š

1. åˆ›å»ºé€šé…ç¬¦è·¯ç”±ï¼š/cloud/:funcNameï¼ŒfuncNameï¼šäº‘å‡½æ•°åç§°
2. å®ç°ä¸€ä¸ªé€šç”¨å…³é—­åº”ç”¨æ¥å£shutdown
3. ç¡®å®šå¤–éƒ¨æ¨¡å—å¼•å…¥æ‰“æ ‡ä½ç½®ï¼Œç¤ºä¾‹ä¸º9ï¼Œ29ï¼ˆè¿™ä¸ªåé¢ç”¨åˆ°ï¼‰

```javascript
const Koa = require('koa');
const Router = require('koa-router');
const KoaStatic = require('koa-static');
const cors = require('@koa/cors');
const bodyParser = require('koa-bodyparser');
const path = require('path');
const fs = require('fs');
const { NodeVM } = require('vm2');
/** ä¾èµ–åº“ï¼Œæ‰“æ ‡ä½ç½® */

function query() {
  const jsonStr = fs.readFileSync(path.join(__dirname, `../db/func.json`)).toString();
  try {
    return JSON.parse(jsonStr);
  } catch (error) {
    return null;
  }
}

const app = new Koa();
const router = new Router();

const vm = new NodeVM({
  require: {
    external: true,
    root: './',
  },
  sandbox: {
    // æ¬¡æ•°æ’å…¥ä¾èµ–ï¼Œ æ‰“æ ‡ä½ç½®
  },
  // wrapper: 'node',
});

router.post('/cloud/:funcName', async function (ctx) {
  const funcName = ctx.params.funcName;
  const { body } = ctx.request;
  const cloud = query() || {};
  const result = vm.run(cloud.script);

  try {
    ctx.body = await result.handler(body);
  } catch (error) {
    ctx.body = { message: error.message };
  }
});

router.post('/shutdown', (req, res) => {
  // åœ¨è¿™é‡Œæ‰§è¡Œå…³é—­æ“ä½œ
  app.close(() => {
    console.log('Server has been shut down.');
  });
});

app.use(bodyParser());
app.use(cors());
app.use(router.routes()).use(router.allowedMethods());
app.listen(8001);
```

2. **åˆ›å»ºäº‘å‡½æ•°**

å‚è€ƒä¸Šé¢koaæ ‡å‡†æ¨¡ç‰ˆï¼Œæ„å»ºä¸€ä¸ªäº‘å‡½æ•°ç®¡ç†æœåŠ¡
å…³é”®æ­¥éª¤ï¼š

1. ç®€å•èµ·è§ï¼Œæˆ‘ä»¬ç›´æ¥ä½¿ç”¨jsonæ–‡ä»¶å­˜å‚¨äº‘å‡½æ•°
2. åˆ›å»ºæˆåŠŸåæ”¹å‡½æ•°åå°±ä¸èƒ½è¢«å…¶ä»–äººåœ¨ä½¿ç”¨

```typescript
router.post('/cloud/create', async function (ctx) {
  const { body } = ctx.request;
  await save(`../db/func.json`, { funcName: body.funcName });
  ctx.body = { code: 0, msg: 'npm install sunccess' };
});
```

3. **å®ç°äº‘å‡½æ•°å¹¶è¿è¡Œ**

å…³é”®æ­¥éª¤ï¼š

1. æ ¡éªŒäº‘å‡½æ•°åˆæ³•æ€§
2. æŠŠäº‘å‡½æ•°å®ç°å†…å®¹å­˜å‚¨åˆ°åˆšåˆ›å»ºçš„äº‘å‡½æ•°ä¸­
3. é€šè¿‡child_processæä¾›çš„spawnæ–¹æ³•å¯åŠ¨ä¸€ä¸ªå­è¿›ç¨‹è¿è¡Œåˆšåˆ›å»ºçš„äº‘å‡½æ•°æœåŠ¡

```javascript
router.post('/cloud/save', async function (ctx) {
  const { body } = ctx.request;
  // æ ¡éªŒé€»è¾‘çœç•¥
  const cloud = query(`../db/func.json`) || {};
  cloud.script = body.script;
  await save(`../db/func.json`, cloud);
  // å­è¿›ç¨‹å¯åŠ¨nodeæœåŠ¡
  nodeStart(`../cloudFunction/vm2.js`);
  ctx.body = { code: 0, msg: 'func is run' };
});
```

4. **å¤„ç†å¤–éƒ¨æ¨¡å—ï¼ˆnpmåŒ…ï¼‰**

vm2é»˜è®¤æ˜¯éš”ç¦»ä¸Šä¸‹æ–‡å½“ä¸­çš„å±€éƒ¨å˜é‡æˆ–å‡½æ•°çš„ï¼Œæ­¤æ—¶å¦‚æœä¸åœ¨ç¨‹åºä¸­å®‰è£…ä¾èµ–äº‘å‡½æ•°æ˜¯æ— æ³•æ­£å¸¸è¿è¡Œçš„ï¼ŒNodeVMä¸­æä¾›sandboxå‚æ•°å¯ä»¥æ³¨å…¥ä¾èµ–çš„æ¨¡å—,æ¯”å¦‚æƒ³ä½¿ç”¨dayjsåŒ…ï¼š

```javascript
const dayjs = require(dayjs);
vm = new NodeVM({
  sandbox: {
    dayjs
  },
});
```

å…³é”®æ­¥éª¤ï¼š

1. åˆ›å»ºå®‰è£…ä¾èµ–çš„æ¥å£
2. åˆ›å»ºå®‰è£…ä¾èµ–å‘½ä»¤ï¼šnpm install :npmName,å¹¶é€šè¿‡execSyncæ‰§è¡Œåˆ°äº‘å‡½æ•°æ‰€åœ¨ç›®å½•
3. å…³é—­å­è¿›ç¨‹ä¸­è¿è¡Œäº‘å‡½æ•°NodeæœåŠ¡
4. è·å–åˆšåˆ›å»ºçš„äº‘å‡½æ•°ä¸»åº”ç”¨æ–‡ä»¶ï¼Œå¹¶æŒ‰è¡Œè¿›è¡Œæ•°ç»„å¤„ç†
5. æ ¹æ®ä¸Šé¢æ‰“æ ‡çš„ä½ç½®ï¼ŒæŠŠè¿™ä¸¤ä¸ªä»£ç æ’å…¥äº‘å‡½æ•°æºç å¯¹åº”çš„ä½ç½®ï¼š
   1. const npmName = require('npmName');
   2. npmName: npmName,
6. ä¿®æ”¹è¿‡çš„æºç è¦†ç›–åŸæ¥çš„ä»£ç ï¼›
7. é‡æ–°é€šè¿‡spawn('node', [path.join(__dirname, 'äº‘å‡½æ•°ä¸»å…¥å£è·¯å¾„')])é‡å¯äº‘å‡½æ•°æœåŠ¡ï¼›

```javascript
router.post('/cloud/npminstall', async function (ctx) {
  const { body } = ctx.request;
  const { npmName } = body; // ç‰ˆæœ¬
  const npmCommand = `npm install ${npmName}`;
  execSync(npmCommand, { cwd: '../cloudFunction' });
  await axios.post('http://localhost:8001/shutdown', {});
  const cloud = query(`../db/func.json`) || {};
  cloud.npmName = npmName;
  await save(`../db/func.json`, cloud);
  // 2.ä¿®æ”¹ä»£ç ï¼šï¼šï¼šå½“ç„¶ï¼Œå®Œæ•´åŠŸèƒ½è¿™é‡Œè¦ä¿å­˜ä»£ç å¿«ç…§ï¼Œå¯ä»¥åˆ‡æ¢å›æ»š
  // è¯»å–éœ€è¦æ·»åŠ é…ç½®è¡Œæ•°
  const line = query(`../db/config.json`);
  const fileStr = fs.readFileSync(path.join(__dirname, `../cloudFunction/vm2.js`)).toString();
  const codeLines = fileStr.split('\n');
  codeLines.splice(line.requireLine, 0, `const ${npmName} = require('${npmName}');`);
  codeLines.splice(line.dependLine, 0, `${npmName},`);
  fs.writeFileSync(path.join(__dirname, `../cloudFunction/vm2.js`), codeLines.join('\n'), 'utf8');
  // ä¿®æ”¹æºæ–‡ä»¶å¯ç¼–è¾‘è¡Œæ•°
  // line.requireLine += 1;
  // line.dependLine += 1;
  save(`../db/config.json`, line);
  ctx.body = { code: 0, msg: 'npm install sunccess' };
});
```

è‡³æ­¤ï¼Œæˆ‘ä»¬å®ç°äº†ä¸€ä¸ªç®€æ˜“ç‰ˆçš„äº‘å‡½æ•°ï¼›è¿™é‡Œæ“ä½œäº‘å‡½æ•°æœåŠ¡éƒ½æ˜¯é€šè¿‡nodeçš„å­è¿›ç¨‹å®ç°çš„ï¼Œåœ¨é«˜å¹¶å‘ä¸‹å…¶å®æ˜¯æŒºåƒå†…å­˜çš„ï¼Œå¦‚æœæƒ³åœ¨ç”Ÿäº§ä¸Šåº”ç”¨ï¼ŒæŠŠäº‘å‡½æ•°éƒ¨ç½²åˆ°dockerå®¹å™¨ä¸­æ˜¯æ¯”è¾ƒå¥½çš„é€‰æ‹©ï¼›dockerèƒ½å¤Ÿå®Œå…¨å®ç°éš”ç¦»ï¼Œå¹¶ä¸”ä¸å—ä¸»åº”ç”¨æœåŠ¡å†…å­˜å½±å“ï¼Œç¨³å®šæ€§ä¹Ÿä¼šæ¯”è¾ƒé«˜ï¼›

### å®‰å…¨é˜²æŠ¤

1. **é™åˆ¶èµ„æºè®¿é—®**ï¼šä½¿ç”¨ **vm2** çš„ **NodeVM**æ—¶ï¼Œå¯ä»¥é…ç½®é€‰é¡¹æ¥é™åˆ¶ä»£ç å¯¹ç³»ç»Ÿèµ„æºçš„è®¿é—®æƒé™ã€‚é€šè¿‡è®¾ç½® **sandbox** é€‰é¡¹ï¼Œå¯ä»¥é™åˆ¶è„šæœ¬å¯¹å…¨å±€å¯¹è±¡çš„è®¿é—®ï¼Œä»¥åŠç¦ç”¨å¯¹æŸäº›æ•æ„Ÿæ¨¡å—çš„è®¿é—®ã€‚ä¾‹å¦‚ï¼š

```javascript
const { NodeVM } = require('vm2');
const vm = new NodeVM({
  sandbox: {
    // åœ¨æ²™ç®±ä¸­ç¦ç”¨å…¨å±€å¯¹è±¡è®¿é—®
    console: 'off',
    process: 'off',
    timeout: 1000, //è¶…æ—¶æ—¶é—´
    // é™åˆ¶å¯¹ fs æ¨¡å—çš„è®¿é—®
    fs: {
      readFileSync: 'readonly',
      // å…¶ä»–æ–¹æ³•å¯è®¾ç½®ä¸º 'off'ï¼Œç¦æ­¢è®¿é—®
    },
  },
});
```

2. **éš”ç¦»ç¯å¢ƒ**ï¼šä½¿ç”¨ **NodeVM** åˆ›å»ºéš”ç¦»çš„æ²™ç®±ç¯å¢ƒï¼Œä»¥ç¡®ä¿è„šæœ¬çš„æ‰§è¡Œä¸ä¼šå½±å“ä¸»åº”ç”¨ç¨‹åºã€‚è¿™å¯ä»¥é€šè¿‡åˆ›å»ºå¤šä¸ªç‹¬ç«‹çš„ **NodeVM** å®ä¾‹æ¥å®ç°ï¼Œæ¯ä¸ªå®ä¾‹éƒ½æœ‰è‡ªå·±çš„æ²™ç®±ç¯å¢ƒã€‚
3. **é™åˆ¶è¿è¡Œæ—¶é—´**ï¼šä½¿ç”¨ **timeout** é€‰é¡¹æ¥é™åˆ¶ä»£ç çš„è¿è¡Œæ—¶é—´ï¼Œä»¥é˜²æ­¢æ— é™å¾ªç¯æˆ–é•¿æ—¶é—´è¿è¡Œçš„ä»£ç å ç”¨èµ„æºã€‚
4. **ç™½åå•æ–¹æ³•**ï¼šåªæš´éœ²ç»™æ²™ç®±ç¯å¢ƒå¿…è¦çš„æ–¹æ³•å’Œæ¨¡å—ï¼Œé€šè¿‡ç™½åå•æ–¹å¼é™åˆ¶å…¶å®ƒæ–¹æ³•å’Œæ¨¡å—çš„è®¿é—®ã€‚
5. **ç›‘æ§å’Œæ—¥å¿—**ï¼šåœ¨æ²™ç®±ç¯å¢ƒä¸­è®¾ç½®äº‹ä»¶ç›‘å¬å™¨ï¼Œä»¥ä¾¿ç›‘æ§ä»£ç çš„è¡Œä¸ºã€‚åŒæ—¶ï¼Œè®°å½•ä»£ç æ‰§è¡Œçš„æ—¥å¿—å’Œé”™è¯¯ä¿¡æ¯ï¼Œä»¥ä¾¿æ£€æŸ¥å’Œæ’é™¤é—®é¢˜ã€‚
6. **å®šæœŸå®¡æŸ¥ä»£ç **ï¼šå®šæœŸå®¡æŸ¥å…è®¸åœ¨æ²™ç®±ä¸­è¿è¡Œçš„ä»£ç ï¼Œä»¥ç¡®ä¿å…¶å®‰å…¨æ€§å’Œåˆè§„æ€§ã€‚
7. **ä½¿ç”¨å¯ä¿¡èµ–çš„åº“**ï¼šé¿å…åœ¨æ²™ç®±ä¸­ä½¿ç”¨ä¸å—ä¿¡ä»»æˆ–ä¸å®‰å…¨çš„ç¬¬ä¸‰æ–¹åº“ï¼Œå°½å¯èƒ½ä½¿ç”¨å—ä¿¡ä»»çš„åº“ã€‚

# æ€»ç»“

ä½¿ç”¨äº‘å‡½æ•°æ¨¡å¼å¼€å‘æœ‰æ¯”è¾ƒå¤šçš„å¥½å¤„ï¼Œæ¯ä¸ªäº‘å‡½æ•°æœ‰ç‹¬ç«‹çš„æ²™ç®±ç¯å¢ƒï¼Œä¸ä¸»ç¨‹åºéš”ç¦»ï¼Œçµæ´»æ€§å¤§å¤§æé«˜ï¼Œå¯æ‹“å±•æ€§ä¹Ÿæ¯”è¾ƒé«˜ï¼Œæ¯”å¦‚åŠ¨æ€åœ°æ·»åŠ ã€æ›´æ–°å’Œåˆ é™¤äº‘å‡½æ•°ï¼Œè€Œæ— éœ€é‡æ–°å¯åŠ¨ä¸»åº”ç”¨ç¨‹åºã€‚

# Q&A
